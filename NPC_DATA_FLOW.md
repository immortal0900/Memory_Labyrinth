# NPC System 데이터 흐름 문서

## 1. 게임 로그인 (`POST /api/npc/login`)

### 데이터 흐름도

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              INPUT                                       │
├─────────────────────────────────────────────────────────────────────────┤
│ {                                                                        │
│   "playerId": "10001",                                                     │
│   "scenarioLevel": 3,                                                    │
│   "heroines": [                                                          │
│     {"heroineId": 1, "affection": 50, "memoryProgress": 30, "sanity": 100}│
│   ]                                                                      │
│ }                                                                        │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              가공 과정                                   │
├─────────────────────────────────────────────────────────────────────────┤
│ 1. 각 히로인별 세션 데이터 생성                                           │
│    - player_id, npc_id, npc_type                                        │
│    - conversation_buffer: [] (빈 배열)                                   │
│    - state: {affection, sanity, memoryProgress, emotion}                │
│                                                                          │
│ 2. Redis에 세션 저장 (TTL: 24시간)                                       │
│    - Key: "session:{playerId}:{heroineId}"                              │
│    - 예: "session:10001:1"                                               │
│                                                                          │
│ 3. 대현자 세션도 함께 생성                                                │
│    - Key: "session:{playerId}:0"                                        │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              OUTPUT                                      │
├─────────────────────────────────────────────────────────────────────────┤
│ {                                                                        │
│   "success": true,                                                       │
│   "message": "세션 초기화 완료"                                           │
│ }                                                                        │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 히로인 대화 (`POST /api/npc/heroine/chat/sync`)

### 데이터 흐름도

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              INPUT                                       │
├─────────────────────────────────────────────────────────────────────────┤
│ {                                                                        │
│   "playerId": "10001",                                                     │
│   "heroineId": 1,                                                        │
│   "text": "오늘 기분이 어때?"                                             │
│ }                                                                        │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         1단계: 세션 로드                                  │
├─────────────────────────────────────────────────────────────────────────┤
│ Redis에서 세션 조회                                                       │
│ Key: "session:10001:1"                                                   │
│                                                                          │
│ 조회 결과:                                                               │
│ {                                                                        │
│   "player_id": 10001,                                                    │
│   "npc_id": 1,                                                           │
│   "conversation_buffer": [...이전 대화...],                               │
│   "state": {"affection": 50, "sanity": 100, "memoryProgress": 30, ...}  │
│ }                                                                        │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         2단계: 의도 분류 (Router)                         │
├─────────────────────────────────────────────────────────────────────────┤
│ LLM 호출하여 사용자 메시지 의도 분류 (max_tokens=20으로 속도 최적화)       │
│                                                                          │
│ 히로인 의도 분류 (4가지):                                                │
│ 1. "general": 일상 대화 → 검색 최소화, 바로 응답 생성                     │
│ 2. "memory_recall": 과거 대화 회상 → User Memory 4요소 하이브리드 검색    │
│    예: "우리 전에 뭐 먹었지?", "루파메스를 어떻게 생각해?"               │
│ 3. "scenario_inquiry": 설정/과거/비밀 질문 → DB 시나리오 검색             │
│    예: "고향이 어디야?", "그때 숲에 왜 갔어?", "최근에 돌아온 기억"       │
│ 4. "heroine_recall": 다른 NPC와의 대화 질문 → NPC-NPC 기억 검색          │
│    예: "루파메스랑 무슨 얘기 했어?", "레티아와 무슨 대화 했어?"          │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                ┌───────────────────┼───────────────────┐
                │                   │                   │
        ┌───────┴───────┐   ┌───────┴───────┐   ┌───────┴───────┐
        ▼               ▼   ▼               ▼   ▼               ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│   general   │ │memory_recall│ │scenario_inq │ │heroine_recall│
│ (바로 생성) │ │(User Memory)│ │(시나리오 DB)│ │(NPC-NPC기억)│
└──────┬──────┘ └──────┬──────┘ └──────┬──────┘ └──────┬──────┘
       │               │               │               │
       │               ▼               ▼               ▼
       │        ┌─────────────────────────────────────────────┐
       │        │              의도별 검색 수행                │
       │        ├─────────────────────────────────────────────┤
       │        │ memory_recall:                              │
       │        │   → search_user_memories_hybrid()           │
       │        │   → 4요소 하이브리드 스코어링                │
       │        │   → user_memories에서 검색                  │
       │        │                                             │
       │        │ scenario_inquiry:                           │
       │        │   → heroine_scenarios 테이블 검색           │
       │        │   → memoryProgress 기준 필터링              │
       │        │   → 하이브리드 검색 (pgvector + PGroonga)   │
       │        │                                             │
       │        │ heroine_recall:                             │
       │        │   → search_npc_npc_memories_hybrid()        │
       │        │   → npc_npc_memories에서 검색               │
       │        │   → 중단 시점까지만 유효한 기억 반환         │
       │        └─────────────────────┬───────────────────────┘
       │                              │
       └──────────────┬───────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         3단계: 응답 생성 (Generate)                       │
├─────────────────────────────────────────────────────────────────────────┤
│ 프롬프트 구성:                                                           │
│ ┌─────────────────────────────────────────────────────────────────────┐ │
│ │ 당신은 히로인 레티아입니다.                                          │ │
│ │                                                                     │ │
│ │ [현재 상태]                                                         │ │
│ │ - 호감도: 50, 정신력: 100, 기억진척도: 30                            │ │
│ │                                                                     │ │
│ │ [페르소나]                                                          │ │
│ │ 이름: 레티아                                                        │ │
│ │ 성격: 원칙과 규율을 중요시하며, 군인처럼 딱딱하게 대함               │ │
│ │ 말투: 존댓말                                                        │ │
│ │ [현재 호감도 레벨: mid]                                             │ │
│ │ 반응 스타일: 경계심 완화, 간간이 관심 표현, 여전히 무뚝뚝            │ │
│ │                                                                     │ │
│ │ [장기 기억] 플레이어가 어제 음식을 좋아한다고 말함                   │ │
│ │ [해금된 시나리오] 레티아 기본 기억 정보...                           │ │
│ │ [최근 대화] ...                                                     │ │
│ │ [플레이어 메시지] 오늘 기분이 어때?                                  │ │
│ └─────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
│ LLM 응답 (JSON):                                                         │
│ {                                                                        │
│   "thought": "갑자기 기분을 물어보다니... 이상한 사람이야",               │
│   "text": "...뭐예요? 갑자기 그런 걸 물어보시다니.",                      │
│   "emotion": 0,                                                          │
│   "affection_delta": 2,                                                  │
│   "sanity_delta": 0                                                      │
│ }                                                                        │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         4단계: 후처리 (Post Process)                      │
├─────────────────────────────────────────────────────────────────────────┤
│ 1. 상태 계산:                                                            │
│    - new_affection = 50 + 2 = 52                                        │
│    - new_sanity = 100 + 0 = 100                                         │
│    - new_memoryProgress = calculate_memory_progress(52, 30, 2) = 32     │
│      (affection 50 >= memoryProgress 30 이므로 같이 +2 증가)            │
│                                                                          │
│ 2. Redis 세션 업데이트:                                                  │
│    - state.affection = 52                                               │
│    - state.emotion = 0                                                  │
│    - conversation_buffer에 대화 추가                                     │
│                                                                          │
│ 3. User Memory에 대화 저장 (LLM Fact 추출 후 저장 - 백그라운드):         │
│    - speaker, subject, content_type 메타데이터 포함                      │
│    - content+keywords(JSON) 추출: 주어/목적어/관계 + 상위 카테고리 포함   │
│    - 임베딩 입력: "content (Keywords: ...)"로 결합해 생성               │
│    - keywords 배열을 함께 저장, 중복/충돌 검사 후 저장                   │
│    - 중복/충돌 검사: 0.9 이상 무조건 중복, 0.55 이상 시 LLM 판단         │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              OUTPUT                                      │
├─────────────────────────────────────────────────────────────────────────┤
│ {                                                                        │
│   "text": "...뭐예요? 갑자기 그런 걸 물어보시다니.",                      │
│   "emotion": 0,                                                          │
│   "affection": 52,                                                       │
│   "sanity": 100,                                                         │
│   "memoryProgress": 32                                                   │
│ }                                                                        │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 대현자 대화 (`POST /api/npc/sage/chat/sync`)

### 데이터 흐름도

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              INPUT                                       │
├─────────────────────────────────────────────────────────────────────────┤
│ {                                                                        │
│   "playerId": "10001",                                                     │
│   "text": "이 세계는 어떤 곳이야?"                                        │
│ }                                                                        │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         1단계: 세션 로드                                  │
├─────────────────────────────────────────────────────────────────────────┤
│ Redis Key: "session:10001:0" (npc_id=0은 대현자)                         │
│                                                                          │
│ {                                                                        │
│   "state": {"scenarioLevel": 3, "emotion": "neutral"}                   │
│ }                                                                        │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         2단계: 의도 분류                                  │
├─────────────────────────────────────────────────────────────────────────┤
│ 분류 결과:                                                               │
│ - "general": 일상 대화                                                   │
│ - "memory_recall": 플레이어와의 과거 대화 질문                           │
│ - "worldview_inquiry": 세계관 질문 → DB 시나리오 검색                    │
│                                                                          │
│ 이 경우: "worldview_inquiry" (세계관 질문)                               │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         3단계: 시나리오 검색                              │
├─────────────────────────────────────────────────────────────────────────┤
│ 조건: scenario_level <= 3 (현재 레벨 이하만 검색)                        │
│                                                                          │
│ 검색 결과:                                                               │
│ - Level 1: "레테는 기억과 망각이 섞인 중세 판타지 행성..."               │
│ - Level 2: "나르가 연합은 6개 종족이 모인 국가..."                       │
│ - Level 3: "카다스는 망각자들이 탐험하는 던전..."                        │
│                                                                          │
│ Level 4 이상 정보는 검색되지 않음 (해금 전)                              │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         4단계: 응답 생성                                  │
├─────────────────────────────────────────────────────────────────────────┤
│ 정보 공개 규칙 적용:                                                      │
│ - 허용: 행성 레테, 암네시아, 망각자, 나르가 연합, 카다스 던전            │
│ - 금지: 디멘시움 근원, 고대 존재, 사트라 정체                            │
│ - 금지 정보 질문시: "아직 때가 아니야"                                   │
│                                                                          │
│ LLM 응답:                                                                │
│ {                                                                        │
│   "thought": "기본적인 질문이군. 알려줘도 되겠지.",                       │
│   "text": "흐음, 이곳이 궁금한가? 레테는 기억과 망각이 뒤섞인 행성이지...",│
│   "emotion": 6,                                                          │
│   "info_revealed": true                                                  │
│ }                                                                        │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              OUTPUT                                      │
├─────────────────────────────────────────────────────────────────────────┤
│ {                                                                        │
│   "text": "흐음, 이곳이 궁금한가? 레테는 기억과 망각이 뒤섞인 행성이지...",│
│   "emotion": 6,                                                          │
│   "scenarioLevel": 3,                                                    │
│   "infoRevealed": true                                                   │
│ }                                                                        │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 히로인간 대화 생성 (`POST /api/npc/heroine-conversation/generate`)

### 데이터 흐름도

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              INPUT                                       │
├─────────────────────────────────────────────────────────────────────────┤
│ {                                                                        │
│   "playerId": "player_10001",                                            │
│   "heroine1Id": 1,                                                       │
│   "heroine2Id": 2,                                                       │
│   "situation": null,    ← null이면 자동 생성                             │
│   "turnCount": 10                                                        │
│ }                                                                        │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         1단계: 상황 생성                                  │
├─────────────────────────────────────────────────────────────────────────┤
│ situation이 null이면 LLM으로 자동 생성:                                  │
│                                                                          │
│ 생성된 상황:                                                             │
│ "셀레파이스 길드 휴게실. 레티아가 창가에서 검을 닦고 있고,               │
│  루파메스가 점심을 먹고 막 들어왔다."                                    │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         2단계: 페르소나 로드                              │
├─────────────────────────────────────────────────────────────────────────┤
│ heroine_persona.yaml에서 로드:                                           │
│                                                                          │
│ 레티아 (ID=1):                                                           │
│ - 성격: 원칙과 규율 중시, 딱딱함                                         │
│ - 말투: 존댓말                                                           │
│ - 루파메스에 대한 관계: 라이벌이자 동료                                  │
│                                                                          │
│ 루파메스 (ID=2):                                                         │
│ - 성격: 열정적, 적극적                                                   │
│ - 말투: 반말                                                             │
│ - 레티아에 대한 관계: 재수없게 강하지만 믿을 수 있음                     │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         3단계: 대화 생성                                  │
├─────────────────────────────────────────────────────────────────────────┤
│ LLM이 두 캐릭터의 대화를 생성:                                           │
│                                                                          │
│ [                                                                        │
│   {"speaker_id": 2, "speaker_name": "루파메스",                          │
│    "text": "야, 레티아! 뭐해?", "emotion": 1},                           │
│   {"speaker_id": 1, "speaker_name": "레티아",                            │
│    "text": "...보면 몰라요? 검을 닦고 있잖아요.", "emotion": 0},         │
│   {"speaker_id": 2, "speaker_name": "루파메스",                          │
│    "text": "아, 맞다! 밥 먹었어? 배고프지 않아?", "emotion": 1},         │
│   ...                                                                    │
│ ]                                                                        │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    4단계: DB 저장 (npc_npc_checkpoints + memories)       │
├─────────────────────────────────────────────────────────────────────────┤
│ 1. npc_npc_checkpoints (체크포인트 - 동기):                             │
│    - player_id: "player_10001"                                          │
│    - heroine_id_1: 1, heroine_id_2: 2  ← (min,max)로 정규화             │
│    - conversation: 대화 전체 JSON 저장                                   │
│    - turn_count: 10                                                      │
│                                                                          │
│ 2. npc_npc_memories (장기기억 - 백그라운드):                            │
│    - LLM으로 중요 fact만 추출 (GPT-5-mini)                              │
│    - speaker_id, subject_id 포함                                        │
│    - 4요소 하이브리드 검색 지원                                          │
│                                                                          │
│ 3. Redis 세션 저장 (동기):                                              │
│    - Key: "npc_npc_session:{player_id}:{min_id}:{max_id}"               │
│    - 최근 대화/인터럽트 처리용                                           │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              OUTPUT                                      │
├─────────────────────────────────────────────────────────────────────────┤
│ {                                                                        │
│   "id": "uuid-xxxx",                                                     │
│   "player_id": "player_10001",                                           │
│   "heroine_id_1": 1,                                                     │
│   "heroine_id_2": 2,                                                     │
│   "situation": "길드 휴게실에서 쉬는 중",                                │
│   "conversation": [                                                      │
│     {"speaker_id": 2, "speaker_name": "루파메스",                        │
│      "text": "야, 레티아! 뭐해?", "emotion": 1},                         │
│     {"speaker_id": 1, "speaker_name": "레티아",                          │
│      "text": "...보면 몰라요? 검을 닦고 있잖아요.", "emotion": 0}        │
│   ],                                                                     │
│   "turn_count": 10,                                                      │
│   "timestamp": "2025-11-28T12:00:00"                                     │
│ }                                                                        │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 길드 진입/퇴장 및 NPC 대화 자동화

### 길드 진입 (`POST /api/npc/guild/enter`)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              INPUT                                       │
├─────────────────────────────────────────────────────────────────────────┤
│ { "playerId": "10001" }                                                    │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         1단계: Redis에 길드 상태 저장                     │
├─────────────────────────────────────────────────────────────────────────┤
│ Key: "guild:10001"                                                       │
│ Value: {"in_guild": true, "entered_at": "2025-11-29T10:00:00"}          │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         2단계: 백그라운드 태스크 시작                     │
├─────────────────────────────────────────────────────────────────────────┤
│ while player가 길드에 있는 동안:                                         │
│   1. 랜덤하게 2명의 히로인 선택 (예: 레티아, 루파메스)                    │
│   2. Redis에 진행 중인 NPC 대화 등록                                     │
│      Key: "npc_conv:10001"                                               │
│      Value: {"active": true, "npc1_id": 1, "npc2_id": 2, ...}           │
│   3. 대화 생성 및 npc_npc_memories에 저장                                │
│   4. 30-60초 대기                                                        │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              OUTPUT                                      │
├─────────────────────────────────────────────────────────────────────────┤
│ { "success": true, "message": "길드에 진입했습니다. NPC 대화가 시작됩니다." }│
└─────────────────────────────────────────────────────────────────────────┘
```

### 대화 인터럽트 흐름

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    상황: 레티아-루파메스 대화 중                          │
├─────────────────────────────────────────────────────────────────────────┤
│ Redis "npc_conv:10001":                                                  │
│ {"active": true, "npc1_id": 1, "npc2_id": 2, "started_at": "..."}       │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    User가 레티아(ID=1)에게 대화 요청                      │
├─────────────────────────────────────────────────────────────────────────┤
│ POST /api/npc/heroine/chat/sync                                         │
│ {"playerId": "10001", "heroineId": 1, "text": "레티아야"}                  │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         인터럽트 확인 및 처리                             │
├─────────────────────────────────────────────────────────────────────────┤
│ is_heroine_in_conversation(10001, 1) → True                             │
│                                                                          │
│ 레티아(ID=1)가 NPC 대화에 참여 중이므로:                                 │
│ → stop_npc_conversation(10001) 호출                                      │
│ → Redis "npc_conv:10001" 삭제                                           │
│ → 레티아-루파메스 대화 중단됨                                            │
│                                                                          │
│ 인터럽트 처리 과정:                                                      │
│ 1. 체크포인트 자르기: npc_npc_checkpoints에서 interruptedTurn 이후 삭제  │
│ 2. 장기기억 무효화: npc_npc_memories에서 해당 턴 이후 invalid_at 설정    │
│ 3. Redis 세션 자르기: 대화 버퍼에서 해당 턴 이후 삭제                    │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         User-레티아 대화 진행                            │
├─────────────────────────────────────────────────────────────────────────┤
│ (정상적인 히로인 대화 흐름 진행)                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 길드 퇴장 (`POST /api/npc/guild/leave`)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              INPUT                                       │
├─────────────────────────────────────────────────────────────────────────┤
│ { "playerId": "10001" }                                                    │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              처리 과정                                   │
├─────────────────────────────────────────────────────────────────────────┤
│ 1. 진행 중인 NPC 대화 정보 백업                                          │
│ 2. Redis "guild:10001" 삭제                                             │
│ 3. Redis "npc_conv:10001" 삭제                                          │
│ 4. 백그라운드 태스크 취소                                                │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              OUTPUT                                      │
├─────────────────────────────────────────────────────────────────────────┤
│ {                                                                        │
│   "success": true,                                                       │
│   "message": "길드에서 퇴장했습니다. NPC 대화가 중단됩니다.",             │
│   "activeConversation": {"npc1_id": 1, "npc2_id": 2, ...}               │
│ }                                                                        │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 데이터 저장소 요약

| 저장소 | 용도 | 데이터 종류 |
|-------|------|-----------|
| **Redis** | Hot Storage | 현재 세션 (대화 버퍼, 상태, 최근 키워드, NPC-NPC 세션) |
| **user_memories** | User-NPC 장기기억 | 플레이어-NPC 대화 (4요소 하이브리드 검색) |
| **npc_npc_checkpoints** | NPC-NPC 체크포인트 | 대화 전체 기록 (인터럽트용) |
| **npc_npc_memories** | NPC-NPC 장기기억 | 중요 fact만 저장 (4요소 하이브리드 검색) |
| **heroine_scenarios** | 시나리오 DB | 히로인 시나리오 (하이브리드 검색) |
| **session_checkpoint** | 세션 체크포인트 | 대화 원문, 상태, 요약 목록 |

### 저장소별 구조

| 저장소 | 테이블/컬럼 | 용도 |
|--------|------------|------|
| **user_memories** | speaker, subject, content_type, keywords, embedding | User-NPC 대화 (4요소 하이브리드, content+keywords 임베딩) |
| **npc_npc_checkpoints** | player_id, heroine_id_1, heroine_id_2, conversation | NPC-NPC 대화 전체 기록 |
| **npc_npc_memories** | speaker_id, subject_id, content_type | NPC-NPC 장기기억 (4요소 하이브리드) |
| **session_checkpoint** | state, summary_list, conversation | 세션 체크포인트, 요약 |

### 검색 범위 (히로인 대화시)

```
User 질문 → 히로인 검색
              │
              ├── 1. user_memories 검색 (User-NPC 대화) - 4요소 하이브리드
              │      └── Score = Recency + Importance + Relevance + Keyword
              │      └── "플레이어가 음식을 좋아한다고 말함" (speaker, subject 포함)
              │
              ├── 2. npc_npc_memories 검색 (NPC간 기억) - 4요소 하이브리드
              │      └── player_id + heroine_id_1/2 기준 검색
              │      └── "루파메스와 음식에 대해 대화함" (speaker_id, subject_id 포함)
              │
              └── 3. heroine_scenarios (해금된 시나리오)
                     └── memoryProgress 기반 필터링
```

---

## 7. 상태 계산 로직

### 호감도 (Affection) 변화

```
INPUT: 사용자 메시지, 현재 호감도, recent_used_keywords
                │
                ▼
┌───────────────────────────────┐
│ 좋아하는 키워드 체크           │
│ (자유, 음식, 평범 등)          │
├───────────────────────────────┤
│ 5턴 내 같은 키워드 사용?       │
│   [Yes] → 반복! 호감도 변화 없음│
│   [No]  → +10                 │
└───────────────┬───────────────┘
                │
                ▼
┌───────────────────────────────┐
│ 트라우마 키워드 체크           │
│ (세일럼, 귀족, 죽음 등)        │
│ → 발견시 -10                  │
└───────────────┬───────────────┘
                │
                ▼
┌───────────────────────────────┐
│ 연애 관련 분석                 │
│ 긍정적: +5 / 부정적: -5        │
└───────────────┬───────────────┘
                │
                ▼
OUTPUT: (새 호감도, 사용된 키워드)

※ 키워드 반복 방지 예시:
  턴1: "음식" → +10 (최초)
  턴2: "음식" → 0 (반복, 무시)
  턴3: "자유" → +10 (다른 키워드)
  턴4: "음식" → 0 (아직 5턴 이내)
  턴5: "음식" → 0 (아직 5턴 이내)
  턴6: "음식" → +10 (5턴 지남, 재사용 가능)
```

### 기억 진척도 (MemoryProgress) 갱신

```
INPUT: new_affection, current_progress, affection_delta
                │
                ▼
┌───────────────────────────────┐
│ 조건 1: affection_delta > 0?  │
└───────────────┬───────────────┘
                │
        ┌───────┴───────┐
        ▼               ▼
      [Yes]           [No]
        │               │
        ▼               ▼
┌───────────────────┐  ┌───────────────┐
│ 조건 2:            │  │ 변화 없음     │
│ new_affection >   │  │               │
│ current_progress? │  │               │
└───────┬───────────┘  └───────────────┘
        │
    ┌───┴───┐
    ▼       ▼
  [Yes]   [No]
    │       │
    ▼       ▼
┌─────────────────────┐  ┌───────────────┐
│ old >= progress?    │  │ 변화 없음     │
│                     │  │               │
│ [Yes] 전체 delta    │  │               │
│ [No]  초과분만 반영 │  │               │
└─────────────────────┘  └───────────────┘

예시 1: old=50, progress=30, delta=2, new=52
  - new(52) > progress(30) ✓
  - old(50) >= progress(30) → 전체 delta 반영
  → memoryProgress = 30 + 2 = 32

예시 2: old=40, progress=47, delta=10, new=50
  - new(50) > progress(47) ✓
  - old(40) < progress(47) → 초과분만 반영
  - 초과분 = new(50) - progress(47) = 3
  → memoryProgress = 47 + 3 = 50

예시 3: old=30, progress=50, delta=10, new=40
  - new(40) <= progress(50) ✗
  → memoryProgress = 50 (변화 없음)

예시 4: affection 60 → 55, memoryProgress 60
  - delta = -5 (감소)
  → memoryProgress = 60 (변화 없음)

※ 중요: memoryProgress는 절대 감소하지 않음
※ 중요: memoryProgress는 100을 초과할 수 없음
```

---

## 8. User-NPC 장기기억 4요소 하이브리드 검색

```
Score = (w_recency × Recency) + (w_importance × Importance) + (w_relevance × Relevance) + (w_keyword × Keyword)

┌─────────────────────────────────────────────────────────────────────────┐
│                        검색 가중치 기본값                               │
├─────────────────────────────────────────────────────────────────────────┤
│ | 요소       | 가중치 | 계산 방식                    | 예시             │
│ |------------|--------|------------------------------|------------------|│
│ | Recency    | 0.15   | exp(-days / 30)              | 7일 전 = 0.79    │
│ | Importance | 0.15   | importance / 10              | 7/10 = 0.70      │
│ | Relevance  | 0.50   | Cosine Similarity (pgvector) | 0.85             │
│ | Keyword    | 0.20   | BM25 정규화 (PGroonga)       | 0.92             │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                        user_memories 테이블 구조                        │
├─────────────────────────────────────────────────────────────────────────┤
│ | 컬럼         | 타입          | 의미                                   │
│ |--------------|---------------|----------------------------------------│
│ | player_id    | TEXT          | 플레이어 ID                            │
│ | heroine_id   | TEXT          | 히로인 ID (letia, lupames, roco, sage) │
│ | speaker      | TEXT          | 발화자 (user, letia, lupames, roco)    │
│ | subject      | TEXT          | 대상 (user, letia, world 등)           │
│ | content      | TEXT          | 추출된 사실 내용                       │
│ | keywords     | TEXT[]        | 주어/목적어/관계/주제 + 상위 카테고리  │
│ | content_type | TEXT          | preference, trait, event, opinion 등   │
│ | embedding    | VECTOR(1536)  | content + keywords 결합 후 임베딩      │
│ | importance   | INT (1-10)    | 중요도                                 │
│ | valid_at     | TIMESTAMPTZ   | 사실이 유효해진 시점                   │
│ | invalid_at   | TIMESTAMPTZ   | 사실이 무효화된 시점 (NULL=현재 유효)  │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                        Fact 추출 예시                                   │
├─────────────────────────────────────────────────────────────────────────┤
│ | 대화                              | speaker | subject | content       │
│ |-----------------------------------|---------|---------|---------------|│
│ | 플레이어: "나는 고양이 좋아해"    | user    | user    | 고양이를 좋아함│
│ | 레티아: "저도 고양이 좋아해요"    | letia   | letia   | 고양이를 좋아함│
│ | 레티아: "오빠는 따뜻한 사람이에요"| letia   | user    | 따뜻한 사람임  │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 9. NPC간 메모리 하이브리드 스코어링 (npc_npc_memories)

```
Score = (w_recency × Recency) + (w_importance × Importance) + (w_relevance × Relevance) + (w_keyword × Keyword)

┌─────────────────────────────────────────────────────────────────────────┐
│                        검색 쿼리                                         │
├─────────────────────────────────────────────────────────────────────────┤
│ search_npc_npc_memories_hybrid(                                         │
│   player_id="player_10001",                                             │
│   heroine_id_1=1, heroine_id_2=2,   ← (min,max)로 정규화                │
│   query="음식"                                                          │
│ )                                                                        │
│ → 레티아(1)-루파메스(2) 대화 중 관련 기억 검색                          │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        스코어 계산 (4요소 하이브리드)                    │
├─────────────────────────────────────────────────────────────────────────┤
│ 기억 1: "루파메스와 음식에 대해 대화함"                                 │
│   - Recency: exp(-days/30) = 0.98 (2시간 전)                           │
│   - Importance: 7/10 = 0.70                                            │
│   - Relevance: cosine_similarity = 0.85                                │
│   - Keyword: BM25 정규화 = 0.90                                         │
│   - Total: 가중치 적용 합산                                             │
│                                                                          │
│ 기억 2: "루파메스가 훈련하자고 함"                                      │
│   - Recency: exp(-days/30) = 0.62 (2일 전)                             │
│   - Importance: 5/10 = 0.50                                            │
│   - Relevance: cosine_similarity = 0.30                                │
│   - Keyword: BM25 정규화 = 0.20                                         │
│   - Total: 가중치 적용 합산                                             │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        결과 (점수 내림차순)                              │
├─────────────────────────────────────────────────────────────────────────┤
│ 1. "루파메스와 음식에 대해 대화함" (speaker_id=2, subject_id=1)        │
│ 2. "루파메스가 훈련하자고 함" (speaker_id=2, subject_id=1)             │
└─────────────────────────────────────────────────────────────────────────┘

※ User-NPC 기억은 user_memories 테이블에서 4요소 하이브리드 검색
※ NPC-NPC 장기기억은 LLM(GPT-5-mini)으로 중요 fact만 추출하여 저장 (백그라운드)
```

---

## 10. TTS 음성 엔드포인트 데이터 흐름

### 10.1 왜 Base64 인코딩을 사용하는가?

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    WAV vs Base64 비교                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  [WAV 바이너리 직접 전송]                                               │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ 문제점:                                                            │  │
│  │ - JSON 응답에 바이너리 데이터 포함 불가                            │  │
│  │ - 텍스트 + 상태 + 음성을 별도 요청으로 처리해야 함                 │  │
│  │ - multipart/form-data 등 복잡한 처리 필요                         │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│  [Base64 인코딩 전송] - 채택                                            │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ 장점:                                                              │  │
│  │ - JSON 응답에 문자열로 포함 가능                                   │  │
│  │ - 텍스트 + 상태 + 음성을 단일 JSON으로 전송                        │  │
│  │ - 언리얼 엔진에서 쉽게 디코딩 가능                                 │  │
│  │ - 전송 중 인코딩 문제 없음                                         │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 10.2 히로인 대화 + 음성 (`POST /api/npc/heroine/chat/sync/voice`)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              INPUT                                       │
├─────────────────────────────────────────────────────────────────────────┤
│ {                                                                        │
│   "playerId": "10001",                                                   │
│   "heroineId": 1,                                                        │
│   "text": "오늘 기분이 어때?"                                             │
│ }                                                                        │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    1단계: 기존 대화 로직 실행                             │
├─────────────────────────────────────────────────────────────────────────┤
│ heroine_agent.generate_response_sync() 호출                             │
│                                                                          │
│ 결과:                                                                   │
│ {                                                                        │
│   "text": "...뭐예요? 갑자기 그런 걸 물어보시다니.",                      │
│   "emotion": 0,                                                          │
│   "emotion_intensity": 1.0,    <- LLM이 자동 생성                       │
│   "affection": 52,                                                       │
│   "sanity": 100,                                                         │
│   "memoryProgress": 32                                                   │
│ }                                                                        │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    2단계: TTS 음성 생성 (Typecast API)                   │
├─────────────────────────────────────────────────────────────────────────┤
│ TypecastTTSService.text_to_speech() 호출                                │
│                                                                          │
│ 입력:                                                                   │
│ - text: "...뭐예요? 갑자기 그런 걸 물어보시다니."                        │
│ - npc_id: 1 (레티아) -> voice: "Mio" (미오)                             │
│ - emotion: 0 (neutral) -> emotion_preset: "neutral"                     │
│ - emotion_intensity: 1.0                                                │
│                                                                          │
│ Typecast API 응답: WAV 바이너리 (audio_bytes)                           │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    3단계: Base64 인코딩                                  │
├─────────────────────────────────────────────────────────────────────────┤
│ audio_base64 = base64.b64encode(audio_bytes).decode("utf-8")           │
│                                                                          │
│ 결과: "UklGRv4qAABXQVZFZm10IBAAAA..."  (문자열)                         │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    4단계: 로컬 저장 (백그라운드)                          │
├─────────────────────────────────────────────────────────────────────────┤
│ BackgroundTasks로 응답 속도에 영향 없이 저장                            │
│                                                                          │
│ 저장 경로: audio_logs/2025-12-18/heroine_chat/heroine_retia/            │
│            {timestamp}_{playerId}_e{emotion}.wav                        │
│                                                                          │
│ 메타데이터 (.txt): NPC 이름, 감정, 텍스트 내용                          │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              OUTPUT                                      │
├─────────────────────────────────────────────────────────────────────────┤
│ {                                                                        │
│   "text": "...뭐예요? 갑자기 그런 걸 물어보시다니.",                      │
│   "emotion": 0,                                                          │
│   "emotion_intensity": 1.0,                                              │
│   "affection": 52,                                                       │
│   "sanity": 100,                                                         │
│   "memoryProgress": 32,                                                  │
│   "audio_base64": "UklGRv4qAABXQVZFZm10IBAAAA..."                       │
│ }                                                                        │
└─────────────────────────────────────────────────────────────────────────┘
```

### 10.3 히로인간 대화 + 음성 (`POST /api/npc/heroine-conversation/generate/voice`)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              INPUT                                       │
├─────────────────────────────────────────────────────────────────────────┤
│ {                                                                        │
│   "playerId": "player_10001",                                            │
│   "heroine1Id": 1,                                                       │
│   "heroine2Id": 2,                                                       │
│   "situation": null,                                                     │
│   "turnCount": 3                                                         │
│ }                                                                        │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    1단계: 대화 생성 (기존 로직)                           │
├─────────────────────────────────────────────────────────────────────────┤
│ heroine_heroine_agent.generate_and_save_conversation() 호출             │
│                                                                          │
│ 결과 (conversation 배열):                                               │
│ [                                                                        │
│   {"speaker_id": 1, "speaker_name": "레티아",                           │
│    "text": "...뭐해.", "emotion": 0, "emotion_intensity": 1.0},         │
│   {"speaker_id": 2, "speaker_name": "루파메스",                          │
│    "text": "야~ 심심해서!", "emotion": 1, "emotion_intensity": 1.5},    │
│   {"speaker_id": 1, "speaker_name": "레티아",                           │
│    "text": "시끄러워요.", "emotion": 4, "emotion_intensity": 0.8}       │
│ ]                                                                        │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    2단계: 각 턴별 TTS 생성 (순차)                         │
├─────────────────────────────────────────────────────────────────────────┤
│ for turn in conversation:                                               │
│                                                                          │
│ Turn 1: speaker=레티아(1), voice=Mio                                    │
│   -> text: "...뭐해." -> TTS -> audio_bytes_1 -> base64_1               │
│                                                                          │
│ Turn 2: speaker=루파메스(2), voice=Sora                                  │
│   -> text: "야~ 심심해서!" -> TTS -> audio_bytes_2 -> base64_2          │
│                                                                          │
│ Turn 3: speaker=레티아(1), voice=Mio                                    │
│   -> text: "시끄러워요." -> TTS -> audio_bytes_3 -> base64_3            │
│                                                                          │
│ * 각 턴마다 해당 speaker의 voice로 개별 TTS 생성                        │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    3단계: 로컬 저장 (백그라운드)                          │
├─────────────────────────────────────────────────────────────────────────┤
│ 각 턴별로 개별 WAV 파일 저장 (피드백용)                                  │
│                                                                          │
│ audio_logs/2025-12-18/heroine_conversation/                             │
│   heroine_retia/201453_623925_6_e0.wav                                  │
│   heroine_retia/201453_623925_6_e0.txt                                  │
│   heroine_lupames/201453_625776_6_e1.wav                                │
│   heroine_lupames/201453_625776_6_e1.txt                                │
│   ...                                                                   │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              OUTPUT                                      │
├─────────────────────────────────────────────────────────────────────────┤
│ {                                                                        │
│   "id": "uuid-xxxx",                                                     │
│   "heroine1_id": 1,                                                      │
│   "heroine2_id": 2,                                                      │
│   "situation": "자동 생성된 상황",                                       │
│   "conversation": [                                                      │
│     {"speaker_id": 1, "speaker_name": "레티아",                         │
│      "text": "...뭐해.", "emotion": 0, "emotion_intensity": 1.0,        │
│      "audio_base64": "UklGRv..."},     <- 턴 1 음성                     │
│     {"speaker_id": 2, "speaker_name": "루파메스",                        │
│      "text": "야~ 심심해서!", "emotion": 1, "emotion_intensity": 1.5,   │
│      "audio_base64": "UklGRv..."},     <- 턴 2 음성                     │
│     {"speaker_id": 1, "speaker_name": "레티아",                         │
│      "text": "시끄러워요.", "emotion": 4, "emotion_intensity": 0.8,     │
│      "audio_base64": "UklGRv..."}      <- 턴 3 음성                     │
│   ],                                                                     │
│   "importance_score": 5,                                                 │
│   "timestamp": "2025-12-18T10:30:00"                                    │
│ }                                                                        │
└─────────────────────────────────────────────────────────────────────────┘
```

### 10.4 음성 매핑 (Typecast Voice)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    NPC -> Typecast Voice 매핑                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ NPC ID │ 이름      │ Typecast Voice │ 특징                       │    │
│  ├────────┼───────────┼────────────────┼────────────────────────────┤    │
│  │ 0      │ 사트라    │ Yubin (유빈)   │ 신비롭고 차분한 목소리     │    │
│  │ 1      │ 레티아    │ Mio (미오)     │ 차갑고 무뚝뚝한 목소리     │    │
│  │ 2      │ 루파메스  │ Sora (소라)    │ 활발하고 밝은 목소리       │    │
│  │ 3      │ 로코      │ Saeron (새론)  │ 순수하고 귀여운 목소리     │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ Emotion -> Typecast Preset 매핑                                  │    │
│  ├─────────────────────────────────────────────────────────────────┤    │
│  │ 0 (neutral)    -> "normal"                                       │    │
│  │ 1 (joy)        -> "happy"                                        │    │
│  │ 2 (fun)        -> "happy" + intensity 조절                       │    │
│  │ 3 (sorrow)     -> "sad"                                          │    │
│  │ 4 (angry)      -> "angry"                                        │    │
│  │ 5 (surprise)   -> "surprised"                                    │    │
│  │ 6 (mysterious) -> "normal" (신비로움은 별도 preset 없음)         │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 10.5 Base64 -> WAV 변환 유틸리티

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    src/tools/audio/base64_to_wav.py                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  사용법 1: Python 코드에서 직접 사용                                    │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ from src.tools.audio.base64_to_wav import save_base64_as_wav      │  │
│  │                                                                    │  │
│  │ save_base64_as_wav(response["audio_base64"], "output.wav")        │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│  사용법 2: CLI로 JSON 파일에서 추출                                     │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ python -m src.tools.audio.base64_to_wav --file response.json ./out│  │
│  │                                                                    │  │
│  │ 결과:                                                              │  │
│  │ - conversation_turn_1_레티아.wav                                   │  │
│  │ - conversation_turn_2_루파메스.wav                                 │  │
│  │ - ...                                                              │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│  사용법 3: Base64 문자열 직접 변환                                      │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ python -m src.tools.audio.base64_to_wav "UklGRv..." output.wav    │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 11. 포트 정보

| 서비스 | 포트 |
|-------|------|
| **FastAPI (NPC API)** | **8090** |
| Redis | 6379 |
| PostgreSQL (Local Docker) | 5435 |
| Supabase | 클라우드 |
