# NPC System 데이터 흐름 문서

## 1. 게임 로그인 (`POST /api/npc/login`)

### 데이터 흐름도

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              INPUT                                       │
├─────────────────────────────────────────────────────────────────────────┤
│ {                                                                        │
│   "playerId": 10001,                                                     │
│   "scenarioLevel": 3,                                                    │
│   "heroines": [                                                          │
│     {"heroineId": 1, "affection": 50, "memoryProgress": 30, "sanity": 100}│
│   ]                                                                      │
│ }                                                                        │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              가공 과정                                   │
├─────────────────────────────────────────────────────────────────────────┤
│ 1. 각 히로인별 세션 데이터 생성                                           │
│    - player_id, npc_id, npc_type                                        │
│    - conversation_buffer: [] (빈 배열)                                   │
│    - state: {affection, sanity, memoryProgress, emotion}                │
│                                                                          │
│ 2. Redis에 세션 저장 (TTL: 24시간)                                       │
│    - Key: "session:{playerId}:{heroineId}"                              │
│    - 예: "session:10001:1"                                               │
│                                                                          │
│ 3. 대현자 세션도 함께 생성                                                │
│    - Key: "session:{playerId}:0"                                        │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              OUTPUT                                      │
├─────────────────────────────────────────────────────────────────────────┤
│ {                                                                        │
│   "success": true,                                                       │
│   "message": "세션 초기화 완료"                                           │
│ }                                                                        │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 히로인 대화 (`POST /api/npc/heroine/chat/sync`)

### 데이터 흐름도

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              INPUT                                       │
├─────────────────────────────────────────────────────────────────────────┤
│ {                                                                        │
│   "playerId": 10001,                                                     │
│   "heroineId": 1,                                                        │
│   "text": "오늘 기분이 어때?"                                             │
│ }                                                                        │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         1단계: 세션 로드                                  │
├─────────────────────────────────────────────────────────────────────────┤
│ Redis에서 세션 조회                                                       │
│ Key: "session:10001:1"                                                   │
│                                                                          │
│ 조회 결과:                                                               │
│ {                                                                        │
│   "player_id": 10001,                                                    │
│   "npc_id": 1,                                                           │
│   "conversation_buffer": [...이전 대화...],                               │
│   "state": {"affection": 50, "sanity": 100, "memoryProgress": 30, ...}  │
│ }                                                                        │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         2단계: 의도 분류 (Router)                         │
├─────────────────────────────────────────────────────────────────────────┤
│ LLM 호출하여 사용자 메시지 의도 분류                                       │
│                                                                          │
│ 분류 결과:                                                               │
│ - "general": 일상 대화 → 바로 응답 생성                                   │
│ - "memory_recall": 과거 대화 → Mem0 검색 후 응답                          │
│ - "scenario_inquiry": 히로인 과거 → DB 시나리오 검색 후 응답               │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    ▼               ▼               ▼
            ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
            │   general   │ │memory_recall│ │scenario_inq │
            │ (바로 생성) │ │ (Mem0 검색) │ │ (DB 검색)   │
            └──────┬──────┘ └──────┬──────┘ └──────┬──────┘
                   │               │               │
                   │               ▼               ▼
                   │        ┌─────────────────────────────┐
                   │        │ 기억 검색 (통합 테이블)      │
                   │        │                             │
                   │        │ search_npc_memories(npc_id) │
                   │        │ → 하이브리드 스코어링       │
                   │        │                             │
                   │        │ 검색 결과 (memory_type별):  │
                   │        │ - user_npc: "음식 좋아함"   │
                   │        │ - npc_conversation: "대화"  │
                   │        │ - npc_memory: "기억"        │
                   │        └─────────────┬───────────────┘
                   │                      │
                   │               ┌──────┴──────┐
                   │               ▼             ▼
                   │        ┌─────────────────────────────┐
                   │        │ DB 시나리오 검색 결과        │
                   │        │ (memoryProgress <= 30 만)   │
                   │        │ "레티아 기본 기억 정보..."   │
                   │        └─────────────┬───────────────┘
                   │                      │
                   └──────────┬───────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         3단계: 응답 생성 (Generate)                       │
├─────────────────────────────────────────────────────────────────────────┤
│ 프롬프트 구성:                                                           │
│ ┌─────────────────────────────────────────────────────────────────────┐ │
│ │ 당신은 히로인 레티아입니다.                                          │ │
│ │                                                                     │ │
│ │ [현재 상태]                                                         │ │
│ │ - 호감도: 50, 정신력: 100, 기억진척도: 30                            │ │
│ │                                                                     │ │
│ │ [페르소나]                                                          │ │
│ │ 이름: 레티아                                                        │ │
│ │ 성격: 원칙과 규율을 중요시하며, 군인처럼 딱딱하게 대함               │ │
│ │ 말투: 존댓말                                                        │ │
│ │ [현재 호감도 레벨: mid]                                             │ │
│ │ 반응 스타일: 경계심 완화, 간간이 관심 표현, 여전히 무뚝뚝            │ │
│ │                                                                     │ │
│ │ [장기 기억] 플레이어가 어제 음식을 좋아한다고 말함                   │ │
│ │ [해금된 시나리오] 레티아 기본 기억 정보...                           │ │
│ │ [최근 대화] ...                                                     │ │
│ │ [플레이어 메시지] 오늘 기분이 어때?                                  │ │
│ └─────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
│ LLM 응답 (JSON):                                                         │
│ {                                                                        │
│   "thought": "갑자기 기분을 물어보다니... 이상한 사람이야",               │
│   "text": "...뭐예요? 갑자기 그런 걸 물어보시다니.",                      │
│   "emotion": "neutral",                                                  │
│   "affection_delta": 2,                                                  │
│   "sanity_delta": 0                                                      │
│ }                                                                        │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         4단계: 후처리 (Post Process)                      │
├─────────────────────────────────────────────────────────────────────────┤
│ 1. 상태 계산:                                                            │
│    - new_affection = 50 + 2 = 52                                        │
│    - new_sanity = 100 + 0 = 100                                         │
│    - new_memoryProgress = calculate_memory_progress(52, 30, 2) = 32     │
│      (affection 50 >= memoryProgress 30 이므로 같이 +2 증가)            │
│                                                                          │
│ 2. Redis 세션 업데이트:                                                  │
│    - state.affection = 52                                               │
│    - state.emotion = "neutral"                                          │
│    - conversation_buffer에 대화 추가                                     │
│                                                                          │
│ 3. Mem0에 대화 저장:                                                     │
│    "플레이어: 오늘 기분이 어때?\n히로인: ...뭐예요? 갑자기..."           │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              OUTPUT                                      │
├─────────────────────────────────────────────────────────────────────────┤
│ {                                                                        │
│   "text": "...뭐예요? 갑자기 그런 걸 물어보시다니.",                      │
│   "emotion": "neutral",                                                  │
│   "affection": 52,                                                       │
│   "sanity": 100,                                                         │
│   "memoryProgress": 30                                                   │
│ }                                                                        │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 히로인 대화 스트리밍 (`POST /api/npc/heroine/chat`)

### 스트리밍 vs 비스트리밍 동일성

**핵심: 스트리밍과 비스트리밍은 동일한 컨텍스트와 프롬프트를 사용합니다.**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    스트리밍/비스트리밍 공통 처리                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  1단계: 컨텍스트 준비 (_prepare_context)                                 │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ - 키워드 분석 (호감도 변화량 사전 계산)                             │  │
│  │ - 의도 분류 (general/memory_recall/scenario_inquiry)              │  │
│  │ - 기억/시나리오 검색 (의도에 따라)                                 │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                    │                                     │
│                                    ▼                                     │
│  2단계: 프롬프트 생성 (_build_full_prompt)                               │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ - 페르소나 + 상태 + 기억 + 시나리오 + 대화기록                     │  │
│  │ - 스트리밍: 텍스트 출력 요청                                       │  │
│  │ - 비스트리밍: JSON 출력 요청                                       │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                    │                                     │
│                                    ▼                                     │
│  3단계: LLM 호출 (1번만!)                                                │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ - 스트리밍: streaming_llm.astream()                                │  │
│  │ - 비스트리밍: llm.ainvoke()                                        │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                    │                                     │
│                                    ▼                                     │
│  4단계: 상태 업데이트 (_update_state_after_response)                     │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ - Redis 세션 업데이트                                              │  │
│  │ - Mem0에 대화 저장                                                 │  │
│  │ - LLM 재호출 없음!                                                 │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 데이터 흐름도

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              INPUT                                       │
├─────────────────────────────────────────────────────────────────────────┤
│ {                                                                        │
│   "playerId": 10001,                                                     │
│   "heroineId": 1,                                                        │
│   "text": "오늘 기분이 어때?"                                             │
│ }                                                                        │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
              (비스트리밍과 완전히 동일한 컨텍스트 준비)
              (키워드 분석 → 의도 분류 → 기억/시나리오 검색)
                                    │
                                    ▼
              (동일한 프롬프트로 LLM 스트리밍 호출)
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         OUTPUT (SSE Stream)                              │
├─────────────────────────────────────────────────────────────────────────┤
│ data: ...                                                                │
│ data: 뭐                                                                 │
│ data: 예요                                                               │
│ data: ?                                                                  │
│ data:  갑자기                                                            │
│ data:  그런                                                              │
│ data:  걸                                                                │
│ data:  물어보시다니                                                       │
│ data: .                                                                  │
│ data: {"type": "final", "affection": 52, "sanity": 100, ...}            │
│ data: [DONE]                                                             │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
              (스트리밍 완료 후 상태 업데이트 - LLM 재호출 없이)
              (Redis 세션 저장, Mem0 기억 저장)
```

---

## 4. 대현자 대화 (`POST /api/npc/sage/chat/sync`)

### 데이터 흐름도

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              INPUT                                       │
├─────────────────────────────────────────────────────────────────────────┤
│ {                                                                        │
│   "playerId": 10001,                                                     │
│   "text": "이 세계는 어떤 곳이야?"                                        │
│ }                                                                        │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         1단계: 세션 로드                                  │
├─────────────────────────────────────────────────────────────────────────┤
│ Redis Key: "session:10001:0" (npc_id=0은 대현자)                         │
│                                                                          │
│ {                                                                        │
│   "state": {"scenarioLevel": 3, "emotion": "neutral"}                   │
│ }                                                                        │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         2단계: 의도 분류                                  │
├─────────────────────────────────────────────────────────────────────────┤
│ 분류 결과:                                                               │
│ - "general": 일상 대화                                                   │
│ - "worldview_inquiry": 세계관 질문 → DB 시나리오 검색                    │
│ - "personal_inquiry": 사트라 본인 질문                                   │
│ - "player_inquiry": 플레이어(멘토) 질문 → DB 검색                        │
│                                                                          │
│ 이 경우: "worldview_inquiry" (세계관 질문)                               │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         3단계: 시나리오 검색                              │
├─────────────────────────────────────────────────────────────────────────┤
│ 조건: scenario_level <= 3 (현재 레벨 이하만 검색)                        │
│                                                                          │
│ 검색 결과:                                                               │
│ - Level 1: "레테는 기억과 망각이 섞인 중세 판타지 행성..."               │
│ - Level 2: "나르가 연합은 6개 종족이 모인 국가..."                       │
│ - Level 3: "카다스는 망각자들이 탐험하는 던전..."                        │
│                                                                          │
│ Level 4 이상 정보는 검색되지 않음 (해금 전)                              │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         4단계: 응답 생성                                  │
├─────────────────────────────────────────────────────────────────────────┤
│ 정보 공개 규칙 적용:                                                      │
│ - 허용: 행성 레테, 암네시아, 망각자, 나르가 연합, 카다스 던전            │
│ - 금지: 디멘시움 근원, 고대 존재, 사트라 정체                            │
│ - 금지 정보 질문시: "아직 때가 아니야"                                   │
│                                                                          │
│ LLM 응답:                                                                │
│ {                                                                        │
│   "thought": "기본적인 질문이군. 알려줘도 되겠지.",                       │
│   "text": "흐음, 이곳이 궁금한가? 레테는 기억과 망각이 뒤섞인 행성이지...",│
│   "emotion": "mysterious",                                               │
│   "info_revealed": true                                                  │
│ }                                                                        │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              OUTPUT                                      │
├─────────────────────────────────────────────────────────────────────────┤
│ {                                                                        │
│   "text": "흐음, 이곳이 궁금한가? 레테는 기억과 망각이 뒤섞인 행성이지...",│
│   "emotion": "mysterious",                                               │
│   "scenarioLevel": 3,                                                    │
│   "infoRevealed": true                                                   │
│ }                                                                        │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 히로인간 대화 생성 (`POST /api/npc/heroine-conversation/generate`)

### 데이터 흐름도

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              INPUT                                       │
├─────────────────────────────────────────────────────────────────────────┤
│ {                                                                        │
│   "heroine1Id": 1,                                                       │
│   "heroine2Id": 2,                                                       │
│   "situation": null,    ← null이면 자동 생성                             │
│   "turnCount": 5                                                         │
│ }                                                                        │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         1단계: 상황 생성                                  │
├─────────────────────────────────────────────────────────────────────────┤
│ situation이 null이면 LLM으로 자동 생성:                                  │
│                                                                          │
│ 생성된 상황:                                                             │
│ "셀레파이스 길드 휴게실. 레티아가 창가에서 검을 닦고 있고,               │
│  루파메스가 점심을 먹고 막 들어왔다."                                    │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         2단계: 페르소나 로드                              │
├─────────────────────────────────────────────────────────────────────────┤
│ heroine_persona.yaml에서 로드:                                           │
│                                                                          │
│ 레티아 (ID=1):                                                           │
│ - 성격: 원칙과 규율 중시, 딱딱함                                         │
│ - 말투: 존댓말                                                           │
│ - 루파메스에 대한 관계: 라이벌이자 동료                                  │
│                                                                          │
│ 루파메스 (ID=2):                                                         │
│ - 성격: 열정적, 적극적                                                   │
│ - 말투: 반말                                                             │
│ - 레티아에 대한 관계: 재수없게 강하지만 믿을 수 있음                     │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         3단계: 대화 생성                                  │
├─────────────────────────────────────────────────────────────────────────┤
│ LLM이 두 캐릭터의 대화를 생성:                                           │
│                                                                          │
│ [                                                                        │
│   {"speaker_id": 2, "speaker_name": "루파메스",                          │
│    "text": "야, 레티아! 뭐해?", "emotion": "happy"},                     │
│   {"speaker_id": 1, "speaker_name": "레티아",                            │
│    "text": "...보면 몰라요? 검을 닦고 있잖아요.", "emotion": "neutral"}, │
│   {"speaker_id": 2, "speaker_name": "루파메스",                          │
│    "text": "아, 맞다! 밥 먹었어? 배고프지 않아?", "emotion": "happy"},   │
│   ...                                                                    │
│ ]                                                                        │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    4단계: 통합 테이블에 저장 (agent_memories)             │
├─────────────────────────────────────────────────────────────────────────┤
│ 3개의 기억을 agent_memories 테이블에 저장:                               │
│                                                                          │
│ 1. NPC간 대화 (npc_conversation):                                       │
│    agent_id: "conv_1_2", memory_type: "npc_conversation"                │
│    content: "루파메스: 야, 레티아! 뭐해?...", importance: 5             │
│                                                                          │
│ 2. NPC 1이 NPC 2에 대한 기억:                                           │
│    agent_id: "npc_1_about_2", memory_type: "npc_memory"                 │
│    content: "루파메스와 대화함: 야, 레티아! 뭐해?..."                   │
│                                                                          │
│ 3. NPC 2가 NPC 1에 대한 기억:                                           │
│    agent_id: "npc_2_about_1", memory_type: "npc_memory"                 │
│    content: "레티아와 대화함: 야, 레티아! 뭐해?..."                     │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              OUTPUT                                      │
├─────────────────────────────────────────────────────────────────────────┤
│ {                                                                        │
│   "id": "uuid-xxxx",                                                     │
│   "agent_id": "conv_1_2",                                                │
│   "memory_type": "npc_conversation",                                     │
│   "content": "루파메스: 야, 레티아! 뭐해?\n레티아: ...보면 몰라요?",    │
│   "conversation": [                                                      │
│     {"speaker_id": 2, "speaker_name": "루파메스",                        │
│      "text": "야, 레티아! 뭐해?", "emotion": "happy"},                   │
│     {"speaker_id": 1, "speaker_name": "레티아",                          │
│      "text": "...보면 몰라요? 검을 닦고 있잖아요.", "emotion": "neutral"}│
│   ],                                                                     │
│   "importance_score": 5,                                                 │
│   "timestamp": "2025-11-28T12:00:00"                                     │
│ }                                                                        │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 5.1 히로인간 대화 생성 스트리밍 (`POST /api/npc/heroine-conversation/stream`)

### 스트리밍 vs 비스트리밍 동일성

**핵심: 스트리밍도 비스트리밍과 동일하게 DB에 저장됩니다.**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    스트리밍/비스트리밍 공통 처리                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  1단계: 상황 생성 (situation이 null이면)                                 │
│                                                                          │
│  2단계: 프롬프트 생성 (_build_conversation_prompt)                       │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ - 페르소나 + 관계 + 상황                                           │  │
│  │ - 스트리밍: [이름] (감정) 대사 형식 요청                           │  │
│  │ - 비스트리밍: JSON 배열 형식 요청                                  │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│  3단계: LLM 호출 (1번만!)                                                │
│                                                                          │
│  4단계: DB 저장 (_save_conversation_to_db)                               │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ - 스트리밍: 텍스트 → JSON 파싱 후 저장                             │  │
│  │ - 비스트리밍: JSON 직접 저장                                       │  │
│  │ - 동일한 테이블(agent_memories)에 저장                             │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 데이터 흐름도

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              INPUT                                       │
├─────────────────────────────────────────────────────────────────────────┤
│ {                                                                        │
│   "heroine1Id": 1,                                                       │
│   "heroine2Id": 2,                                                       │
│   "situation": null,                                                     │
│   "turnCount": 5                                                         │
│ }                                                                        │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
                    (비스트리밍과 동일한 1-2단계 가공 과정)
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         OUTPUT (SSE Stream)                              │
├─────────────────────────────────────────────────────────────────────────┤
│ data: [루파메스]                                                         │
│ data:  (happy)                                                           │
│ data:  야,                                                               │
│ data:  레티아!                                                           │
│ data:  뭐해?                                                             │
│ data:                                                                    │
│ data: [레티아]                                                           │
│ data:  (neutral)                                                         │
│ data:  ...보면                                                           │
│ data:  몰라요?                                                           │
│ data:  검을                                                              │
│ data:  닦고                                                              │
│ data:  있잖아요.                                                         │
│ data: ...                                                                │
│ data: [DONE]                                                             │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    스트리밍 완료 후 DB 저장 (비스트리밍과 동일)           │
├─────────────────────────────────────────────────────────────────────────┤
│ 1. 텍스트 응답 → JSON으로 파싱 (_parse_streaming_response)              │
│    "[레티아] (neutral) ...뭐해." → {"speaker_id": 1, "text": "...뭐해."}│
│                                                                          │
│ 2. agent_memories 테이블에 저장 (_save_conversation_to_db)              │
│    - npc_conversation: 대화 전체                                        │
│    - npc_memory: 각 히로인의 관점에서 상대방에 대한 기억                 │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 5.2 길드 진입/퇴장 및 NPC 대화 자동화

### 길드 진입 (`POST /api/npc/guild/enter`)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              INPUT                                       │
├─────────────────────────────────────────────────────────────────────────┤
│ { "playerId": 10001 }                                                    │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         1단계: Redis에 길드 상태 저장                     │
├─────────────────────────────────────────────────────────────────────────┤
│ Key: "guild:10001"                                                       │
│ Value: {"in_guild": true, "entered_at": "2025-11-29T10:00:00"}          │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         2단계: 백그라운드 태스크 시작                     │
├─────────────────────────────────────────────────────────────────────────┤
│ while player가 길드에 있는 동안:                                         │
│   1. 랜덤하게 2명의 히로인 선택 (예: 레티아, 루파메스)                    │
│   2. Redis에 진행 중인 NPC 대화 등록                                     │
│      Key: "npc_conv:10001"                                               │
│      Value: {"active": true, "npc1_id": 1, "npc2_id": 2, ...}           │
│   3. 대화 생성 및 agent_memories에 저장                                  │
│   4. 30-60초 대기                                                        │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              OUTPUT                                      │
├─────────────────────────────────────────────────────────────────────────┤
│ { "success": true, "message": "길드에 진입했습니다. NPC 대화가 시작됩니다." }│
└─────────────────────────────────────────────────────────────────────────┘
```

### 대화 인터럽트 흐름

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    상황: 레티아-루파메스 대화 중                          │
├─────────────────────────────────────────────────────────────────────────┤
│ Redis "npc_conv:10001":                                                  │
│ {"active": true, "npc1_id": 1, "npc2_id": 2, "started_at": "..."}       │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    User가 레티아(ID=1)에게 대화 요청                      │
├─────────────────────────────────────────────────────────────────────────┤
│ POST /api/npc/heroine/chat                                              │
│ {"playerId": 10001, "heroineId": 1, "text": "레티아야"}                  │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         인터럽트 확인 및 처리                             │
├─────────────────────────────────────────────────────────────────────────┤
│ is_heroine_in_conversation(10001, 1) → True                             │
│                                                                          │
│ 레티아(ID=1)가 NPC 대화에 참여 중이므로:                                 │
│ → stop_npc_conversation(10001) 호출                                      │
│ → Redis "npc_conv:10001" 삭제                                           │
│ → 레티아-루파메스 대화 중단됨                                            │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         User-레티아 대화 진행                            │
├─────────────────────────────────────────────────────────────────────────┤
│ (정상적인 히로인 대화 흐름 진행)                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 길드 퇴장 (`POST /api/npc/guild/leave`)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              INPUT                                       │
├─────────────────────────────────────────────────────────────────────────┤
│ { "playerId": 10001 }                                                    │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              처리 과정                                   │
├─────────────────────────────────────────────────────────────────────────┤
│ 1. 진행 중인 NPC 대화 정보 백업                                          │
│ 2. Redis "guild:10001" 삭제                                             │
│ 3. Redis "npc_conv:10001" 삭제                                          │
│ 4. 백그라운드 태스크 취소                                                │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              OUTPUT                                      │
├─────────────────────────────────────────────────────────────────────────┤
│ {                                                                        │
│   "success": true,                                                       │
│   "message": "길드에서 퇴장했습니다. NPC 대화가 중단됩니다.",             │
│   "activeConversation": {"npc1_id": 1, "npc2_id": 2, ...}               │
│ }                                                                        │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 데이터 저장소 요약

| 저장소 | 용도 | 데이터 종류 |
|-------|------|-----------|
| **Redis** | Hot Storage | 현재 세션 (대화 버퍼, 상태, 최근 키워드) |
| **Mem0** | User-NPC 장기기억 | 플레이어-NPC 대화 (자동 필터링, 중요) |
| **agent_memories** | NPC간 메모리 | NPC간 기억/대화 (하이브리드 스코어링) |
| **scenarios** | 시나리오 DB | 히로인/대현자 시나리오 (벡터 검색) |

### 저장소별 구조

| 저장소 | memory_type | agent_id 형식 | 용도 |
|--------|-------------|---------------|------|
| **Mem0** | - | `player_{id}_npc_{id}` | User-NPC 대화 (★ 중요) |
| **agent_memories** | `npc_memory` | `npc_1_about_2` | NPC A가 B에 대한 기억 |
| **agent_memories** | `npc_conversation` | `conv_1_2` | NPC간 대화 |

### 검색 범위 (히로인 대화시)

```
User 질문 → 히로인 검색
              │
              ├── 1. Mem0 검색 (User-NPC 대화)
              │      └── "플레이어가 음식을 좋아한다고 말함"
              │
              ├── 2. agent_memories 검색 (NPC간 기억)
              │      └── 하이브리드 스코어링 적용
              │      ├── npc_memory: "루파메스에 대한 기억..."
              │      └── npc_conversation: "루파메스와 음식 이야기..."
              │
              └── 3. heroine_scenarios (해금된 시나리오)
                     └── memoryProgress 기반 필터링
```

---

## 7. 상태 계산 로직

### 호감도 (Affection) 변화

```
INPUT: 사용자 메시지, 현재 호감도, recent_used_keywords
                │
                ▼
┌───────────────────────────────┐
│ 좋아하는 키워드 체크           │
│ (자유, 음식, 평범 등)          │
├───────────────────────────────┤
│ 5턴 내 같은 키워드 사용?       │
│   [Yes] → 반복! 호감도 변화 없음│
│   [No]  → +10                 │
└───────────────┬───────────────┘
                │
                ▼
┌───────────────────────────────┐
│ 트라우마 키워드 체크           │
│ (세일럼, 귀족, 죽음 등)        │
│ → 발견시 -10                  │
└───────────────┬───────────────┘
                │
                ▼
┌───────────────────────────────┐
│ 연애 관련 분석                 │
│ 긍정적: +5 / 부정적: -5        │
└───────────────┬───────────────┘
                │
                ▼
OUTPUT: (새 호감도, 사용된 키워드)

※ 키워드 반복 방지 예시:
  턴1: "음식" → +10 (최초)
  턴2: "음식" → 0 (반복, 무시)
  턴3: "자유" → +10 (다른 키워드)
  턴4: "음식" → 0 (아직 5턴 이내)
  턴5: "음식" → 0 (아직 5턴 이내)
  턴6: "음식" → +10 (5턴 지남, 재사용 가능)
```

### 기억 진척도 (MemoryProgress) 갱신

```
INPUT: new_affection, current_progress, affection_delta
                │
                ▼
┌───────────────────────────────┐
│ 조건 1: affection_delta > 0?  │
└───────────────┬───────────────┘
                │
        ┌───────┴───────┐
        ▼               ▼
      [Yes]           [No]
        │               │
        ▼               ▼
┌───────────────────┐  ┌───────────────┐
│ 조건 2:            │  │ 변화 없음     │
│ new_affection >   │  │               │
│ current_progress? │  │               │
└───────┬───────────┘  └───────────────┘
        │
    ┌───┴───┐
    ▼       ▼
  [Yes]   [No]
    │       │
    ▼       ▼
┌─────────────────────┐  ┌───────────────┐
│ old >= progress?    │  │ 변화 없음     │
│                     │  │               │
│ [Yes] 전체 delta    │  │               │
│ [No]  초과분만 반영 │  │               │
└─────────────────────┘  └───────────────┘

예시 1: old=50, progress=30, delta=2, new=52
  - new(52) > progress(30) ✓
  - old(50) >= progress(30) → 전체 delta 반영
  → memoryProgress = 30 + 2 = 32

예시 2: old=40, progress=47, delta=10, new=50
  - new(50) > progress(47) ✓
  - old(40) < progress(47) → 초과분만 반영
  - 초과분 = new(50) - progress(47) = 3
  → memoryProgress = 47 + 3 = 50

예시 3: old=30, progress=50, delta=10, new=40
  - new(40) <= progress(50) ✗
  → memoryProgress = 50 (변화 없음)

예시 4: affection 60 → 55, memoryProgress 60
  - delta = -5 (감소)
  → memoryProgress = 60 (변화 없음)

※ 중요: memoryProgress는 절대 감소하지 않음
※ 중요: memoryProgress는 100을 초과할 수 없음
```

---

## 8. NPC간 메모리 하이브리드 스코어링

```
Score = (w_recency * Recency) + (w_importance * Importance) + (w_relevance * Relevance)

┌─────────────────────────────────────────────────────────────────────────┐
│                        검색 쿼리                                         │
├─────────────────────────────────────────────────────────────────────────┤
│ search_npc_memories(npc_id=1, query="음식")                             │
│ → 레티아(ID=1)와 관련된 NPC간 기억 검색                                 │
│                                                                          │
│ 내부적으로 검색되는 agent_id 패턴:                                       │
│ - conv_*_1 또는 conv_1_* (레티아 참여 대화)                             │
│ - npc_1_about_* (레티아가 다른 NPC에 대해)                              │
│ - npc_*_about_1 (다른 NPC가 레티아에 대해)                              │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        스코어 계산                                       │
├─────────────────────────────────────────────────────────────────────────┤
│ 기억 1: (npc_conversation) "루파메스와 음식에 대해 대화함"              │
│   - Recency: exp(-0.01 * 2h) = 0.98 (2시간 전)                         │
│   - Importance: 7/10 = 0.70                                            │
│   - Relevance: cosine_similarity = 0.85                                │
│   - Total: 0.98 + 0.70 + 0.85 = 2.53                                   │
│                                                                          │
│ 기억 2: (npc_memory) "루파메스가 훈련하자고 함"                         │
│   - Recency: exp(-0.01 * 48h) = 0.62 (2일 전)                          │
│   - Importance: 5/10 = 0.50                                            │
│   - Relevance: cosine_similarity = 0.30                                │
│   - Total: 0.62 + 0.50 + 0.30 = 1.42                                   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        결과 (점수 내림차순)                              │
├─────────────────────────────────────────────────────────────────────────┤
│ 1. "루파메스와 음식에 대해 대화함" [2.53] (npc_conversation)           │
│ 2. "루파메스가 훈련하자고 함" [1.42] (npc_memory)                      │
└─────────────────────────────────────────────────────────────────────────┘

※ User-NPC 기억("플레이어가 음식을 좋아한다고 말함")은 Mem0에서 별도 검색
```

---

## 9. 포트 정보

| 서비스 | 포트 |
|-------|------|
| **FastAPI (NPC API)** | **8090** |
| Redis | 6379 |
| PostgreSQL (Local Docker) | 5435 |
| Supabase | 클라우드 |

