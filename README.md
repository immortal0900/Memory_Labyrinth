# Memory Labyrinth

![Python](https://img.shields.io/badge/python-3.12+-blue?logo=python&logoColor=white)
![FastAPI](https://img.shields.io/badge/FastAPI-0.115+-009688?logo=fastapi&logoColor=white)
![LangChain](https://img.shields.io/badge/LangChain-0.3+-1C3C3C?logo=langchain&logoColor=white)
![LangGraph](https://img.shields.io/badge/LangGraph-0.2+-FF4154)
![PostgreSQL](https://img.shields.io/badge/PostgreSQL-pgvector-336791?logo=postgresql&logoColor=white)
![Redis](https://img.shields.io/badge/Redis-7-DC382D?logo=redis&logoColor=white)
![Langfuse](https://img.shields.io/badge/Langfuse-2.0-FF6F00?logo=langfuse&logoColor=white)
![DeepEval](https://img.shields.io/badge/DeepEval-0.1-8A2BE2?logo=python&logoColor=white)
---
# ëª©ì°¨

- [1. í”„ë¡œì íŠ¸ ì†Œê°œ](#1-í”„ë¡œì íŠ¸-ì†Œê°œ)
- [2. ì£¼ìš” ê¸°ëŠ¥](#2-ì£¼ìš”-ê¸°ëŠ¥)
- [3. ê¸°ìˆ  ìŠ¤íƒ](#3-ê¸°ìˆ -ìŠ¤íƒ)
- [4. ë¹ ë¥¸ ì‹œì‘](#4-ë¹ ë¥¸-ì‹œì‘)
- [5. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •](#5-í™˜ê²½-ë³€ìˆ˜-ì„¤ì •)
- [6. í”„ë¡œì íŠ¸ êµ¬ì¡°](#6-í”„ë¡œì íŠ¸-êµ¬ì¡°)
- [7. ì•„í‚¤í…ì²˜](#7-ì•„í‚¤í…ì²˜)
- [8. API ì—”ë“œí¬ì¸íŠ¸](#8-api-ì—”ë“œí¬ì¸íŠ¸)
- [9. ê°œë°œ ê°€ì´ë“œ](#9-ê°œë°œ-ê°€ì´ë“œ)
- [10. ì½”ë“œ ì»¨ë²¤ì…˜](#10-ì½”ë“œ-ì»¨ë²¤ì…˜)
- [11. ê´€ë ¨ ë¬¸ì„œ](#11-ê´€ë ¨-ë¬¸ì„œ)
- [12. ë¬¸ì˜](#12-ë¬¸ì˜)

---

# 1. í”„ë¡œì íŠ¸ ì†Œê°œ

[![Memory Labyrinth Demo](https://img.youtube.com/vi/EnXhQHyzOe4/maxresdefault.jpg)](https://www.youtube.com/watch?v=EnXhQHyzOe4)


- í”„ë¡œì íŠ¸ëª… : MEMORIA LABYRINTH(ê¸°ì–µì˜ ë˜ì „)
- ì¥ë¥´ : ì„œë¸Œì»¬ì²˜ ë©€í‹°í”Œë ˆì´ ë¡œê·¸ë¼ì´í¬ ê²Œì„
- ì§„í–‰ ê¸°ê°„ : 2025.11 ~ 2026.01 (2ê°œì›”)
- ê¸°íšì˜ë„ : ê¸°ì¡´ê²Œì„ì˜ ë¬¸ì œì ì„ AIë¥¼ ì´ìš©í•´ì„œ íƒ€íŒŒí•˜ê³ ì í•¨
    - ê¸°ì¡´ ì„œë¸Œì»¬ì³ ê²Œì„ ë¬¸ì œ:
        - ì„ íƒì§€ê°€ í•œì •ë˜ì–´ ìˆìŒ â†’ í‹€ì´ ì—†ëŠ” ëŒ€í™”
        - ë‚®ì€ ììœ ë„ â†’ ë†’ì€ ììœ ë„
    - ê¸°ì¡´ ë¡œê·¸ë¼ì´í¬ ê²Œì„ ë¬¸ì œ:
        - íŒ¨í„´í™”ëœ ì½˜í…ì¸  â†’ ë³€í™”í•˜ëŠ” ì½˜í…ì¸ 
        - ì œì‘ ë¹„ìš©ì˜ í•œê³„ â†’ ìë™ìƒì„±ìœ¼ë¡œ íš¨ìœ¨ì  ê°œë°œ
- íƒ€ê²Ÿ :
    - íˆë¡œì¸ê³¼ ì •ì„œì  ìœ ëŒ€ê°ì„ ì›í•˜ëŠ” ìœ ì €
    - ëì—†ëŠ” ì„ íƒì§€ë¥¼ ì›í•˜ëŠ” ìœ ì €
    - ë§¤ ìˆœê°„ ìƒˆë¡œìš´ ê²½í—˜ì„ ì›í•˜ëŠ” ìœ ì €

---
# 2. ì£¼ìš” ê¸°ëŠ¥

## NPC AI Agent

### ë‚˜ë¥¼ ê¸°ì–µí•˜ëŠ” npc

[!["ë‚´ê°€ ì¢‹ì•„í•˜ëŠ” ê³¼ì¼ì´ ë­”ì§€ ì•Œì•„?"](https://img.youtube.com/vi/IE9S_yssxEg/sddefault.jpg)](https://youtu.be/IE9S_yssxEg)
- ì˜ë¯¸ì—†ëŠ” ë‹¨ìˆœ ì¼ìƒëŒ€í™”ê°€ ì €ì¥ë ì‹œ RAG ê²€ìƒ‰ì„±ëŠ¥ì´ ë–¨ì–´ì§€ë¯€ë¡œ ì¥ê¸°ê¸°ì–µì—” í•µì‹¬ë§Œì €ì¥(í•˜ì§€ë§Œ ì „ì²´ ëŒ€í™”ë¥¼ ì €ì¥í•˜ëŠ” check point ë”°ë¡œ ì¡´ì¬)
- redisë¥¼ ì´ìš©í•´ ë‹¨ê¸° ê¸°ì–µì„ êµ¬ì¶•í•˜ê³  pgvectorë¡œ ì¥ê¸°ê¸°ì–µì„ êµ¬ì¶•í•œë’¤ ë‹¨ê¸°ê¸°ì–µì„ ìš”ì•½í• ë•Œ ì¤‘ìš”ë„ì™€ ì €ì¥ì‹œê°„ì„ ê¸°ì¤€ìœ¼ë¡œ list í˜•íƒœë¡œ ì €ì¥í•˜ì—¬ ì“°ë ˆê¸° ë°ì´í„°ê°€ ê³„ì†ì—ì„œ ìš”ì•½ì— ë“¤ì–´ì˜¤ëŠ” ê²ƒì„ ë°©ì§€í•¨
- ê¸°ì–µ ì €ì¥ì‹œ ìƒìœ„ê°œë…ì„ í•¨ê»˜ ì €ì¥í•˜ì—¬ ë‹¨ì–´ë¥¼ íŠ¹ì •í•˜ì§€ ì•Šë”ë¼ë„ ì¸ê°„ì´ ê¸°ì–µí• ë•Œ ë²”ì£¼ë¥¼ ë‚˜ëˆ„ë“¯ ê¸°ì–µí•¨ 
- ì¤‘ë³µë˜ëŠ” ë‚´ìš©ì˜ ê²½ìš° ê³¼ê±°ì˜ ë‚´ìš©ì„ ë¹„í™œì„±í™”í•˜ì—¬ RAGê²€ìƒ‰ì‹œ ë°ì´í„°ì˜ í¸í–¥ê³¼ ì·¨í–¥ì— ëŒ€í•œ í˜¼ë€ì„ ë°©ì§€í•¨
- ë‹¨ìˆœ ì˜ë¯¸ + í‚¤ì›Œë“œ ê¸°ë°˜ í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ì—ì„œ ë‚˜ì•„ê°€ "ì‹œê°„"ê³¼ "ì¤‘ìš”ë„"ê¹Œì§€ í¬í•¨í•˜ì—¬ ì¸ê°„ì²˜ëŸ¼ ìµœì‹ ì˜ê¸°ì–µê³¼ ì¤‘ìš”í•œ ë‚´ìš©ì„ ë” ì˜ê¸°ì–µí•˜ë„ë¡ í•¨

### í•œì •ë˜ì§€ ì•Šì€ ì„ íƒì§€
[!["ê¸¸ë“œì—ì„œëŠ” ì‚´ë§Œí•´?"](https://img.youtube.com/vi/Dib6eY1wCRk/sddefault.jpg)](https://youtu.be/Dib6eY1wCRk)
- ì˜ë„ë¶„ë¥˜ë¥¼ í†µí•´ ì¼ìƒëŒ€í™”ëŠ” ë¹ ë¥´ê²Œ ì¥ê¸°ê¸°ì–µìœ¼ë¡œ ë¶„ë¥˜ë ì‹œ ê·¸ê²ƒê³¼ ë§ëŠ” ê¸°ì–µë§Œ ê²€ìƒ‰í•´ì„œ íš¨ìœ¨ì ì„(RAGê²€ìƒ‰ì‹œ)

### í˜¸ê°ë„ ì¦ê°€ì— ë”°ë¥¸ íƒœë„ ë³€í™”ì™€ ê¸°ì–µí•´ê¸ˆ
[![í˜¸ê°ë„ ì¦ê°€ì— ë”°ë¥¸ íƒœë„ë³€í™”ì™€ ê¸°ì–µí•´ê¸ˆ](https://img.youtube.com/vi/dYacAGct7Go/sddefault.jpg)](https://youtu.be/dYacAGct7Go)
- ìœ ì €ì—ê²Œ í•´ê¸ˆë˜ì§€ ì•Šì€ ê¸°ì–µì€ ë§í•˜ì§€ ì•ŠìŒ
- ì‹œë‚˜ë¦¬ì˜¤(íˆë¡œì¸ì˜ ê³¼ê±°ê¸°ì–µ)ë¡œ ë¶„ë¥˜ë ì‹œ ëŒ€ì¶© ë§í•´ë„ ê¸°ì–µì„ ì˜ ê°€ì ¸ì˜¤ë„ë¡ DBì— ë©”íƒ€ë°ì´í„°ë¥¼ í•¨ê»˜ ì €ì¥í•¨
- ê¸°ì–µì´ ëŒì•„ì™”ë‹¤ê³  í”Œë ˆì´ì–´ì—ê²Œ ë§í•˜ê²Œ ë˜ë©´ ê¼¬ë¦¬ì§ˆë¬¸ì„ í•˜ê²Œ ë í…ë° ê·¸ì— ëŒ€ì‘í•˜ê¸° ìœ„í•´ ì˜ë„ë¶„ë¥˜í”„ë¡¬í”„íŠ¸ì— ìµœê·¼ 3í„´ì˜ ëŒ€í™”ê°€ ë™ì ìœ¼ë¡œ ë“¤ì–´ì˜¤ê³  í•´ê¸ˆì§í›„ 5í„´ê°„ í•´ê¸ˆëœ ê¸°ì–µì´ ì‚½ì…ë¨

### NPC-NPC ëŒ€í™” ë„ì¤‘ ëŠì–´ë„ ìì—°ìŠ¤ëŸ½ê²Œ ê¸°ì–µ ìœ ì§€
[![NPC-NPC ëŒ€í™”](https://img.youtube.com/vi/MaeQMhavXXY/sddefault.jpg)](https://youtu.be/MaeQMhavXXY)
- ìƒí™©ë„ ìƒì„±ë˜ê³  ìƒí™©ì— ë”°ë¥¸ ëŒ€í™”ë„ íˆë¡œì¸ì˜ ê¸°ì–µì§„ì²™ë„, ì •ì‹ ë ¥, ì¢‹ì•„í•˜ëŠ” ë‹¨ì–´, ìµœê·¼ëŒ€í™” ë“±ì— ë”°ë¼ ìƒì„±ë¨
- ì „ì²´ëŒ€í™”ë¥¼ í´ë¼ì´ì–¸íŠ¸ì— ë³´ë‚´ì§€ë§Œ í”Œë ˆì´ì–´ì…ì¥ì—ì„œëŠ” ëŠì€ ì´í›„ëŠ” ì¼ì–´ë‚˜ì§€ ì•Šì€ ì¼ì´ë¯€ë¡œ ëŠì€ ì´í›„ í„´ì„ ì²´í¬í¬ì¸íŠ¸ ì¥ê¸°ê¸°ì–µ ì„¸ì…˜ë²„í¼ì—ì„œ ì‚­ì œí•¨

### ê°ì •í‘œí˜„ê³¼ ê°ì •ì˜ ì •ë„ê¹Œì§€ í‘œí˜„ ê°€ëŠ¥í•œ TTS
[![ë‚´ ì´ë¦„ì„ ë¶ˆëŸ¬ì£¼ëŠ” NPC](https://img.youtube.com/vi/PmAdAOp1Soc/sddefault.jpg)](https://youtu.be/PmAdAOp1Soc)
- ë¯¸ë¦¬ ë…¹ìŒëœ ì†Œë¦¬ê°€ ì•„ë‹ˆë¯€ë¡œ ë‚´ ì´ë¦„ì„ ë¶ˆëŸ¬ì£¼ëŠ”ê²Œ ê°€ëŠ¥í•¨(ê¸°ì¡´ê²Œì„ì€ "ìë„¤" í˜¹ì€ "ëª¨í—˜ê°€"ë¼ê³  ë¶ˆë¦¼)
- Typecastë¥¼ ì´ìš©í•´ ê°ì •ì˜ ìƒíƒœì™€ ì •ë„ë¥¼ ë°˜ì˜í•˜ëŠ” ëª©ì†Œë¦¬
- ë™ì  í”„ë¡¬í”„íŠ¸ì™€ CoTë¥¼ í™œìš©í•´ í˜ë¥´ì†Œë‚˜ ì¼ê´€ì„±ì„ ìœ ì§€

## Dungeon AI Agent

### ë˜ì „ì´ë²¤íŠ¸
- íˆë¡œì¸ì˜ ê¸°ì–µ ì§„ì²™ë„(ê¸°ì–µí•´ê¸ˆì •ë„), ì„¸ê³„ê´€ ì‹œë‚˜ë¦¬ì˜¤ í•´ê¸ˆì •ë„ì— ë”°ë¼ ì´ë²¤íŠ¸ê°€ ë‹¬ë¼ì§€ë©° ìì—°ì–´ë¡œ ì–´ë–»ê²Œ í• ì§€ ì„ íƒí•˜ê³  ì„ íƒì— ë”°ë¥¸ ë³´ìƒì€ ëª¬ìŠ¤í„°, ë””ë²„í”„, ë²„í”„, ì•„ì´í…œ ë“±ì´ ë  ìˆ˜ ìˆìŒ
- ìƒì„± ì‹œê°„ì´ ìˆì–´ì„œ 1ì¸µì˜ ê²½ìš° 1,2 ì¸µ ë™ì‹œì— ìƒì„±ë˜ë©° 2ì¸µì— ë„ë‹¬ì‹œ ë¶€í„°ëŠ” í•´ë‹¹ì¸µì— ë„ë‹¬í–ˆì„ë•Œ ë‹¤ìŒì¸µ ì´ë²¤íŠ¸ê°€ ìƒì„±ë¨ 

### ë˜ì „ë°¸ëŸ°ì‹±
- ë³´ìŠ¤ë°©ì— ë„ì°©í–ˆì„ë•Œ(ê°€ì¥ ê°•í•´ì¡Œì„ë•Œ)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë‹¤ìŒì¸µì˜ ë°¸ëŸ°ì‹±ì´ ì§„í–‰ë¨
- íˆë¡œì¸ì˜ ë‚¨ì€ ì²´ë ¥ì— ë”°ë¼ ìŠ¤í‚¬ì˜ í‚¤ì›Œë“œ, ë¬´ê¸°ì˜ í‚¤ì›Œë“œì— ë”°ë¥¸ ëª¬ìŠ¤í„°ê°€ ë‹¤ìŒì¸µì— ë°°ì¹˜ë¨ (ì˜ˆì‹œ: "ëŠë¦°ê³µê²©", "ë„‰ë°±"ì´ë¼ëŠ” í‚¤ì›Œë“œë¥¼ ê°€ì§„ íˆë¡œì¸ ì²´ë ¥ì´ ë§ì„ ê²½ìš° ì¹´ìš´í„° ì¹  ìˆ˜ ìˆëŠ” "ë¹ ë¥¸ê³µê²©", "ë„‰ë°±ì €í•­", "ì›ê±°ë¦¬" ëª¬ìŠ¤í„°ê°€ ë°°ì •ë¨ )

## Fairy AI Agent

### ë˜ì „ ê¸¸ì¡ì´ ì—­í• 
- ë˜ì „ ì •ë³´ë¥¼ ë°›ì•„ì„œ ë˜ì „ë‚´ì—ì„œ ì§„í–‰ë“±ì— ëŒ€í•´ ë¬¼ì–´ë³¼ ìˆ˜ ìˆìŒ(ì˜ˆì‹œ: "ì´ì œ ì–´ë””ë¡œ ê°€ì•¼ë¼?", "ì € ëª¬ìŠ¤í„° ê³µëµë²• ì•Œë ¤ì¤˜", "ë‹¤ìŒë°©ì— ë­ê°€ ìˆì–´?", "ì¸ë²¤í† ë¦¬ì— ë­ìˆì–´?" ë“±)

### STTë¡œ ë˜ì „ë‚´ ìƒí˜¸ì‘ìš© ê°€ëŠ¥
- ìŒì„±ìœ¼ë¡œ ê°„í¸í•˜ê²Œ ìƒí˜¸ì‘ìš© ê°€ëŠ¥(ì˜ˆì‹œ: "ë¶ˆ ì¼œì¤˜", "OOë¬´ê¸°ë¡œ ë°”ê¿”ì¤˜", "ì œì¼ ì„¼ ë¬´ê¸°ë¡œ ë°”ê¿”ì¤˜" ë“±)


---

# 3. ê¸°ìˆ  ìŠ¤íƒ

## AI Framework
- **LangChain** 0.3.0+ / **LangGraph** 0.2.0+ (State Management, Workflow)
- **X.AI Grok-4-1-fast-non-reasoning** (ì£¼ìš” LLM, ì˜ë„ ë¶„ë¥˜ + ì‘ë‹µ ìƒì„±)
- **OpenAI** (GPT-5-mini, text-embedding-3-small)
- **Groq Llama 3.3 70B** (Fairy ê°€ì´ë“œìš©)
- **KoBERT** (í•œêµ­ì–´ ì˜ë„ ë¶„ë¥˜)
- **BGE-M3** (ì„ë² ë”© ê¸°ë°˜ ì•„ì´í…œ ë§¤ì¹­)
- **Langfuse** 3.0.0+ (LLM ì¶”ì , í† í° ì‚¬ìš©ëŸ‰/ë¹„ìš© ë¶„ì„)
- **DeepEval** 0.21+ (NPC í˜ë¥´ì†Œë‚˜ í‰ê°€)

## Backend
- **FastAPI** 0.115.0+ (API ì„œë²„)
- **Uvicorn** 0.32.0+ (ASGI ì„œë²„)
- **Pydantic** 2.0+ (Data Validation)
- **Python** 3.12+

## Database
- **PostgreSQL** (ParadeDB: pgvector + PGroonga)
  - `pgvector`: HNSW ì¸ë±ìŠ¤ ê¸°ë°˜ ë²¡í„° ê²€ìƒ‰
  - `PGroonga`: í•œêµ­ì–´ í˜•íƒœì†Œ ë¶„ì„ + BM25 í‚¤ì›Œë“œ ê²€ìƒ‰
- **Redis** 7 (ë‹¨ê¸° ë©”ëª¨ë¦¬, ì„¸ì…˜ ê´€ë¦¬, 24ì‹œê°„ TTL)
- **ChromaDB** 0.5.0+ (ì‹¤í—˜ìš© ë²¡í„° DB)

## Audio
- **Typecast API** (TTS ìŒì„± í•©ì„±)
- **OpenAI Whisper** (STT, ìŒì„± ì¸ì‹)
- **Pydub** (ì˜¤ë””ì˜¤ íŒŒì¼ ë³€í™˜)
- **SoundFile** (WAV íŒŒì¼ ì½ê¸°/ì“°ê¸°)

## Infrastructure
- **Docker Compose** (PostgreSQL + Redis)
- **uv** (Python íŒ¨í‚¤ì§€ ê´€ë¦¬ì)

---

# 4. ë¹ ë¥¸ ì‹œì‘

## ì‚¬ì „ ìš”êµ¬ì‚¬í•­

- **Python** 3.12 ì´ìƒ
- **Docker** & **Docker Compose**
- **uv** íŒ¨í‚¤ì§€ ê´€ë¦¬ì

```bash
# uv ì„¤ì¹˜ (pip ì‚¬ìš©)
pip install uv
```

## ì„¤ì¹˜ ë° ì‹¤í–‰

```bash
# 1. ì €ì¥ì†Œ í´ë¡ 
git clone https://github.com/your-username/Memory_Labyrinth.git
cd Memory_Labyrinth

# 2. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
cp .env.example .env
# .env íŒŒì¼ì„ ì—´ì–´ API í‚¤ ì…ë ¥ (ì•„ë˜ "í™˜ê²½ ë³€ìˆ˜ ì„¤ì •" ì„¹ì…˜ ì°¸ì¡°)

# 3. Docker ì»¨í…Œì´ë„ˆ ì‹œì‘ (PostgreSQL + Redis)
docker-compose up -d

# 4. ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”
docker exec -i game_db psql -U postgres -d game_db < init.sql

# 5. ì˜ì¡´ì„± ì„¤ì¹˜
uv sync

# 6. ì„œë²„ ì‹¤í–‰
uv run uvicorn main:app --host 0.0.0.0 --port 8000

# ì„œë²„ í™•ì¸
# http://localhost:8000 ì ‘ì†
# API ë¬¸ì„œ: http://localhost:8000/docs
```

---

# 5. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

`.env` íŒŒì¼ì— ë‹¤ìŒ í™˜ê²½ ë³€ìˆ˜ë¥¼ ì„¤ì •í•˜ì„¸ìš”.

## í•„ìˆ˜ ë³€ìˆ˜

| ë³€ìˆ˜ëª… | ì„¤ëª… | ì˜ˆì‹œ |
|--------|------|------|
| `OPENAI_API_KEY` | OpenAI API í‚¤<br/>- ì„ë² ë”©: text-embedding-3-small<br/>- ë³´ì¡° LLM: GPT-4o-mini | `sk-proj-...` |
| `XAI_API_KEY` | X.AI API í‚¤<br/>- ì£¼ìš” LLM: grok-4-1-fast-non-reasoning<br/>- NPC ì˜ë„ ë¶„ë¥˜ ë° ì‘ë‹µ ìƒì„± | `xai-...` |
| `DATABASE_URL` | PostgreSQL ì—°ê²° ë¬¸ìì—´<br/>- ë¡œì»¬: `postgresql://postgres:password@localhost:5435/game_db`<br/>- Supabase: `postgresql://user:pass@host:6543/postgres` | `postgresql://postgres:password@localhost:5435/game_db` |
| `REDIS_URL` | Redis ì—°ê²° ë¬¸ìì—´<br/>- ë‹¨ê¸° ë©”ëª¨ë¦¬, ì„¸ì…˜ ê´€ë¦¬ | `redis://localhost:6379/0` |

## ì„ íƒ ë³€ìˆ˜ (ê¸°ëŠ¥ë³„)

### TTS ìŒì„± í•©ì„±

| ë³€ìˆ˜ëª… | ì„¤ëª… | ì˜ˆì‹œ |
|--------|------|------|
| `TYPECAST_API_KEY` | Typecast API í‚¤<br/>- NPC ìŒì„± ìƒì„±<br/>- ì—†ìœ¼ë©´ í…ìŠ¤íŠ¸ë§Œ ë°˜í™˜ (ìŒì„± ì—†ìŒ) | `your-typecast-api-key-here` |

### LLM ì¶”ì  (Langfuse)

| ë³€ìˆ˜ëª… | ì„¤ëª… | ì˜ˆì‹œ |
|--------|------|------|
| `LANGFUSE_SECRET_KEY` | Langfuse Secret í‚¤<br/>- í† í° ì‚¬ìš©ëŸ‰, ë¹„ìš©, ì§€ì—°ì‹œê°„ ì¶”ì  | `sk-lf-...` |
| `LANGFUSE_PUBLIC_KEY` | Langfuse Public í‚¤ | `pk-lf-...` |
| `LANGFUSE_HOST` | Langfuse í˜¸ìŠ¤íŠ¸ | `https://us.cloud.langfuse.com` |

### ì¶”ê°€ LLM í”Œë«í¼

| ë³€ìˆ˜ëª… | ì„¤ëª… | ì˜ˆì‹œ |
|--------|------|------|
| `GROQ_API_KEY` | Groq API í‚¤<br/>- Llama 3.3 70B ì‹¤í–‰ í”Œë«í¼<br/>- Fairy ê°€ì´ë“œ ì‹œìŠ¤í…œì—ì„œ ì‚¬ìš© | `gsk_...` |

---

# 6. í”„ë¡œì íŠ¸ êµ¬ì¡°

```
Memory_Labyrinth/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ agents/                    # LangGraph ê¸°ë°˜ AI ì—ì´ì „íŠ¸
â”‚   â”‚   â”œâ”€â”€ npc/                   # NPC ëŒ€í™” ì‹œìŠ¤í…œ (17ê°œ ëª¨ë“ˆ)
â”‚   â”‚   â”‚   â”œâ”€â”€ base_npc_agent.py           # ê¸°ë³¸ NPC í´ë˜ìŠ¤
â”‚   â”‚   â”‚   â”œâ”€â”€ heroine_agent.py            # íˆë¡œì¸ ì—ì´ì „íŠ¸
â”‚   â”‚   â”‚   â”œâ”€â”€ sage_agent.py               # ëŒ€í˜„ì ì—ì´ì „íŠ¸
â”‚   â”‚   â”‚   â”œâ”€â”€ heroine_heroine_agent.py    # NPC ê°„ ëŒ€í™”
â”‚   â”‚   â”‚   â”œâ”€â”€ memory_retriever.py         # ë©”ëª¨ë¦¬ ê²€ìƒ‰
â”‚   â”‚   â”‚   â”œâ”€â”€ npc_conversation_manager.py # ëŒ€í™” ê´€ë¦¬
â”‚   â”‚   â”‚   â”œâ”€â”€ *_intent_classifier.py      # ì˜ë„ ë¶„ë¥˜
â”‚   â”‚   â”‚   â”œâ”€â”€ *_prompt_builder.py         # í”„ë¡¬í”„íŠ¸ ìƒì„±
â”‚   â”‚   â”‚   â””â”€â”€ emotion_mapper.py           # ê°ì • ë§¤í•‘
â”‚   â”‚   â”œâ”€â”€ fairy/                 # ìš”ì • ê°€ì´ë“œ AI
â”‚   â”‚   â”‚   â”œâ”€â”€ dungeon/                    # ë˜ì „ ë‚´ë¹„ê²Œì´ì…˜
â”‚   â”‚   â”‚   â”œâ”€â”€ guild/                      # ê¸¸ë“œ ì‹œìŠ¤í…œ
â”‚   â”‚   â”‚   â””â”€â”€ interaction/                # ìƒí˜¸ì‘ìš© í•¸ë“¤ëŸ¬
â”‚   â”‚   â””â”€â”€ dungeon/               # ë˜ì „ AI
â”‚   â”‚       â”œâ”€â”€ event/                      # ì´ë²¤íŠ¸ ìƒì„±
â”‚   â”‚       â”œâ”€â”€ monster/                    # ëª¬ìŠ¤í„° ì „íˆ¬ AI
â”‚   â”‚       â””â”€â”€ super/                      # í†µí•© ë˜ì „ ì—ì´ì „íŠ¸
â”‚   â”œâ”€â”€ api/                       # FastAPI ë¼ìš°í„°
â”‚   â”‚   â”œâ”€â”€ npc_router.py                   # NPC ëŒ€í™” API
â”‚   â”‚   â”œâ”€â”€ fairy_router.py                 # ìš”ì • ê°€ì´ë“œ API
â”‚   â”‚   â”œâ”€â”€ dungeon_router.py               # ë˜ì „ API
â”‚   â”‚   â””â”€â”€ common_router.py                # ê³µí†µ API
â”‚   â”œâ”€â”€ db/                        # ë°ì´í„°ë² ì´ìŠ¤ ë§¤ë‹ˆì €
â”‚   â”‚   â”œâ”€â”€ user_memory_manager.py          # User-NPC ì¥ê¸° ê¸°ì–µ
â”‚   â”‚   â”œâ”€â”€ npc_npc_memory_manager.py       # NPC-NPC ì¥ê¸° ê¸°ì–µ
â”‚   â”‚   â”œâ”€â”€ session_checkpoint_manager.py   # ì„¸ì…˜ ì²´í¬í¬ì¸íŠ¸
â”‚   â”‚   â”œâ”€â”€ redis_manager.py                # Redis ë‹¨ê¸° ë©”ëª¨ë¦¬
â”‚   â”‚   â”œâ”€â”€ RDBRepository.py                # PostgreSQL ì €ì¥ì†Œ
â”‚   â”‚   â””â”€â”€ VectorDBRepository.py           # ë²¡í„° DB ì €ì¥ì†Œ
â”‚   â”œâ”€â”€ services/                  # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
â”‚   â”‚   â”œâ”€â”€ heroine_scenario_service.py     # íˆë¡œì¸ ì‹œë‚˜ë¦¬ì˜¤
â”‚   â”‚   â””â”€â”€ sage_scenario_service.py        # ëŒ€í˜„ì ì‹œë‚˜ë¦¬ì˜¤
â”‚   â”œâ”€â”€ core/                      # ê²Œì„ ë°ì´í„° DTO
â”‚   â”‚   â””â”€â”€ game_dto/                       # Stat, Item, Dungeon ë“±
â”‚   â”œâ”€â”€ prompts/                   # LLM í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿
â”‚   â”‚   â”œâ”€â”€ prompt_type/npc/                # NPC í”„ë¡¬í”„íŠ¸ (YAML)
â”‚   â”‚   â”œâ”€â”€ prompt_type/fairy/              # ìš”ì • í”„ë¡¬í”„íŠ¸ (YAML)
â”‚   â”‚   â””â”€â”€ prompt_type/dungeon/            # ë˜ì „ í”„ë¡¬í”„íŠ¸ (YAML)
â”‚   â”œâ”€â”€ tools/                     # ìœ í‹¸ë¦¬í‹° ë„êµ¬
â”‚   â”‚   â”œâ”€â”€ audio/                          # TTS, STT
â”‚   â”‚   â””â”€â”€ rag/                            # RAG ë„êµ¬
â”‚   â”œâ”€â”€ tests/                     # í…ŒìŠ¤íŠ¸
â”‚   â”‚   â”œâ”€â”€ npc/persona_eval/               # DeepEval NPC í‰ê°€
â”‚   â”‚   â””â”€â”€ share/                          # ê³µí†µ í…ŒìŠ¤íŠ¸
â”‚   â””â”€â”€ utils/                     # ê³µí†µ ìœ í‹¸ë¦¬í‹°
â”‚       â””â”€â”€ langfuse_tracker.py             # Langfuse ì¶”ì 
â”œâ”€â”€ main.py                        # FastAPI ì•± ì§„ì…ì 
â”œâ”€â”€ docker-compose.yml             # PostgreSQL + Redis
â”œâ”€â”€ init.sql                       # DB ìŠ¤í‚¤ë§ˆ ì´ˆê¸°í™”
â”œâ”€â”€ pyproject.toml                 # uv ì˜ì¡´ì„± ê´€ë¦¬ (55ê°œ)
â”œâ”€â”€ .env.example                   # í™˜ê²½ ë³€ìˆ˜ í…œí”Œë¦¿
â”œâ”€â”€ README.md                      # ì´ ë¬¸ì„œ
â””â”€â”€ docs/                          # ë¬¸ì„œ
    â”œâ”€â”€ NPC_API_PROTOCOL.md                 # API í”„ë¡œí† ì½œ
    â”œâ”€â”€ NPC_CONTEXT.md                      # ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜
    â”œâ”€â”€ NEW_LONGMEMORY_SYSTEM.MD            # ë©”ëª¨ë¦¬ ì‹œìŠ¤í…œ
    â””â”€â”€ SESSION_CHECKPOINT_SUMMARY_SYSTEM.md # ì„¸ì…˜ ê´€ë¦¬
```


---
# 7. ì•„í‚¤í…ì²˜

## NPC AI Agent ì•„í‚¤í…ì²˜

```mermaid
flowchart TB
    subgraph CLIENT["ğŸ® Unreal Engine Client"]
        A[ê²Œì„ ì‹œì‘] --> B[ê¸¸ë“œ ì§„ì…]
    end

    subgraph HEROINE_CHAT["ğŸ‘© íˆë¡œì¸ ëŒ€í™”"]
        C["/api/npc/heroine/chat/sync/voice"]
        C --> C1[ì˜ë„ ë¶„ë¥˜ LLM]
        C1 --> C2{ì˜ë„ íƒ€ì…}
        C2 -->|general| C3[ë°”ë¡œ ì‘ë‹µ ìƒì„±]
        C2 -->|memory_recall| C4[User Memory ê²€ìƒ‰]
        C2 -->|scenario_inquiry| C5[ì‹œë‚˜ë¦¬ì˜¤ DB ê²€ìƒ‰]
        C2 -->|heroine_recall| C6[NPC-NPC ê¸°ì–µ ê²€ìƒ‰]
        C3 & C4 & C5 & C6 --> C7[ì‘ë‹µ ìƒì„± LLM]
        C7 --> C8[TTS ìƒì„±]
        C8 --> C9[text + emotion + audio_base64 ë°˜í™˜]
    end

    subgraph SAGE_CHAT["ğŸ§™ ëŒ€í˜„ì ëŒ€í™”"]
        D["/api/npc/sage/chat/sync/voice"]
        D --> D1[ì˜ë„ ë¶„ë¥˜ LLM]
        D1 --> D2{ì˜ë„ íƒ€ì…}
        D2 -->|general| D3[ë°”ë¡œ ì‘ë‹µ ìƒì„±]
        D2 -->|memory_recall| D4[User Memory ê²€ìƒ‰]
        D2 -->|worldview_inquiry| D5[ì„¸ê³„ê´€ DB ê²€ìƒ‰]
        D3 & D4 & D5 --> D6[ì‘ë‹µ ìƒì„± LLM]
        D6 --> D7[TTS ìƒì„±]
        D7 --> D8[text + emotion + audio_base64 ë°˜í™˜]
    end

    subgraph NPC_CONV["ğŸ‘¥ NPC-NPC ëŒ€í™”"]
        E["/api/npc/heroine-conversation/generate/voice"]
        E --> E1[ë‘ NPC ìƒíƒœ ì¡°íšŒ]
        E1 --> E2[memoryProgressë³„ í•´ê¸ˆ ê¸°ì–µ ì£¼ì…]
        E2 --> E3[ë©€í‹°í„´ ëŒ€í™” ìƒì„± LLM]
        E3 --> E4[ê° í„´ë³„ TTS ìƒì„±]
        E4 --> E5[conversation ë°°ì—´ + audio_base64 ë°˜í™˜]
    end

    subgraph INTERRUPT["âš¡ ì¸í„°ëŸ½íŠ¸ ì²˜ë¦¬"]
        F["/api/npc/heroine-conversation/interrupt"]
        F --> F1[interruptedTurn ì´í›„ ì²´í¬í¬ì¸íŠ¸ ì‚­ì œ]
        F1 --> F2[interruptedTurn ì´í›„ ì¥ê¸°ê¸°ì–µ ë¬´íš¨í™”]
        F2 --> F3[Redis ì„¸ì…˜ ë²„í¼ ìë¥´ê¸°]
        F3 --> F4[ì¤‘ë‹¨ ì‹œì ê¹Œì§€ë§Œ ê¸°ì–µ ìœ ì§€]
    end

    B --> C
    B --> D
    B --> E
    E5 -->|ìœ ì € ê°œì…ì‹œ| F

    style CLIENT fill:#e1f5fe
    style HEROINE_CHAT fill:#fff3e0
    style SAGE_CHAT fill:#f3e5f5
    style NPC_CONV fill:#e8f5e9
    style INTERRUPT fill:#ffebee
```

## NPC Memory ì•„í‚¤í…ì²˜

```mermaid
flowchart TB
    subgraph Input["ğŸ’¬ ëŒ€í™” ì…ë ¥"]
        A["User: ë‚˜ëŠ” ê³ ì–‘ì´ ì¢‹ì•„í•´<br/>NPC: ì €ë„ ê³ ì–‘ì´ ì¢‹ì•„í•´ìš”"]
    end

    subgraph ShortTerm["âš¡ ë‹¨ê¸° ê¸°ì–µ (Redis)"]
        direction TB
        R1["conversation_buffer<br/>(ìµœê·¼ 20í„´)"]
        R2["short_term_summary"]
        R3["session_state<br/>(í˜¸ê°ë„, ì •ì‹ ë ¥, ê¸°ì–µì§„ì²™ë„)"]
        R4["TTL: 24ì‹œê°„"]
    end

    subgraph FactExtract["ğŸ” Fact ì¶”ì¶œ (LLM)"]
        direction TB
        F1["í•µì‹¬ë§Œ ì¶”ì¶œ"]
        F2["Speaker: user"]
        F3["Subject: user"]
        F4["Content: ê³ ì–‘ì´ë¥¼ ì¢‹ì•„í•¨"]
        F5["Keywords: [ê³ ì–‘ì´, ë™ë¬¼, ë°˜ë ¤ë™ë¬¼]"]
        F6["Importance: 7/10"]
    end

    subgraph DuplicateCheck["ğŸ”„ ì¤‘ë³µ ê²€ì‚¬"]
        direction TB
        D1{ìœ ì‚¬ë„ ê²€ì‚¬}
        D2["0.9 ì´ìƒ<br/>â†’ ì¦‰ì‹œ ì¤‘ë³µ ì²˜ë¦¬"]
        D3["0.55~0.9<br/>â†’ LLM ì¶©ëŒ íŒë‹¨"]
        D4["0.55 ë¯¸ë§Œ<br/>â†’ ìƒˆë¡œ ì €ì¥"]
        D1 --> D2
        D1 --> D3
        D1 --> D4
    end

    subgraph LongTerm["ğŸ’¾ ì¥ê¸° ê¸°ì–µ (PostgreSQL)"]
        direction TB
        subgraph UserMem["user_memories"]
            U1["player_id + heroine_id"]
            U2["content + embedding"]
            U3["valid_at / invalid_at<br/>(Bi-temporal)"]
        end
        subgraph NpcNpcMem["npc_npc_memories"]
            N1["player_id + heroine_id_1 + heroine_id_2"]
            N2["speaker + content"]
            N3["conversation_id ì°¸ì¡°"]
        end
    end

    subgraph Checkpoint["ğŸ“ Checkpoint (PostgreSQL)"]
        direction TB
        subgraph SessionCP["session_checkpoints"]
            S1["ë§¤ í„´ ì „ì²´ ëŒ€í™” ì €ì¥"]
            S2["summary_list<br/>(20í„´ë§ˆë‹¤ ìš”ì•½)"]
            S3["state ìŠ¤ëƒ…ìƒ·"]
        end
        subgraph NpcNpcCP["npc_npc_checkpoints"]
            NC1["NPC-NPC ì „ì²´ ëŒ€í™”"]
            NC2["interrupted_turn<br/>(ëŠê¸´ ì‹œì )"]
        end
    end

    subgraph Summary["ğŸ“‹ ìš”ì•½ ì‹œìŠ¤í…œ"]
        direction TB
        SM1["20í„´ë§ˆë‹¤ LLM ìš”ì•½ ìƒì„±"]
        SM2["ì¤‘ìš”ë„ 1~5ì  í‰ê°€"]
        SM3["summary_listì— ì¶”ê°€"]
        SM4["ê°€ì§€ì¹˜ê¸°: 3ì‹œê°„+ë‚®ì€ì¤‘ìš”ë„ ì‚­ì œ<br/>ìµœëŒ€ 5ê°œ ìœ ì§€"]
    end

    subgraph HybridSearch["ğŸ” 4ìš”ì†Œ í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰"]
        direction TB
        H1["Recency 15%<br/>exp(-days/30)"]
        H2["Importance 15%<br/>1~10 ì •ê·œí™”"]
        H3["Relevance 50%<br/>pgvector ì½”ì‚¬ì¸"]
        H4["Keyword 20%<br/>PGroonga BM25"]
        H5["Score = 0.15R + 0.15I + 0.50V + 0.20K"]
    end

    A --> R1
    R1 -->|"ë§¤ í„´"| FactExtract
    FactExtract --> DuplicateCheck
    DuplicateCheck -->|"ì¶©ëŒì‹œ ê¸°ì¡´ invalid_at ì„¤ì •"| LongTerm
    DuplicateCheck -->|"ì‹ ê·œ"| LongTerm

    A -->|"ë§¤ í„´ ì „ì²´ ì €ì¥"| Checkpoint
    R1 -->|"20í„´ë§ˆë‹¤"| Summary
    Summary --> SessionCP

    LongTerm --> HybridSearch
    HybridSearch -->|"ê²€ìƒ‰ ê²°ê³¼"| A

    style Input fill:#e3f2fd,color:#000
    style ShortTerm fill:#fff3e0,color:#000
    style FactExtract fill:#f3e5f5,color:#000
    style DuplicateCheck fill:#ffebee,color:#000
    style LongTerm fill:#e8f5e9,color:#000
    style Checkpoint fill:#e0f7fa,color:#000
    style Summary fill:#fce4ec,color:#000
    style HybridSearch fill:#fff8e1,color:#000
```

### Memory ì €ì¥ íë¦„

| ë‹¨ê³„ | ì €ì¥ì†Œ | ë‚´ìš© | íŠ¹ì§• |
|-----|-------|------|------|
| **1. ë‹¨ê¸° ê¸°ì–µ** | Redis | ìµœê·¼ 20í„´ ëŒ€í™” ë²„í¼ | TTL 24ì‹œê°„, ë¹ ë¥¸ ì ‘ê·¼ |
| **2. Fact ì¶”ì¶œ** | LLM | í•µì‹¬ë§Œ ì¶”ì¶œ (SPO êµ¬ì¡°) | Speaker/Subject/Content ë¶„ë¦¬ |
| **3. ì¤‘ë³µ ê²€ì‚¬** | PostgreSQL | ìœ ì‚¬ë„ 0.55~0.9 â†’ LLM íŒë‹¨ | ì·¨í–¥ ë³€í™” ì‹œ ê¸°ì¡´ ê¸°ì–µ ë¬´íš¨í™” |
| **4. ì¥ê¸° ê¸°ì–µ** | PostgreSQL | user_memories / npc_npc_memories | Bi-temporal (valid_at/invalid_at) |
| **5. Checkpoint** | PostgreSQL | ì „ì²´ ëŒ€í™” + ìš”ì•½ ë¦¬ìŠ¤íŠ¸ | ë¡œê·¸ì¸ ì‹œ ë³µì›ìš© |
| **6. ìš”ì•½** | LLM | 20í„´ë§ˆë‹¤ ìš”ì•½ ìƒì„± | ì¤‘ìš”ë„ ê¸°ë°˜ ê°€ì§€ì¹˜ê¸° (ìµœëŒ€ 5ê°œ) |

### ê²€ìƒ‰ ê°€ì¤‘ì¹˜

$$
Score = (0.15 \times Recency) + (0.15 \times Importance) + (0.50 \times Relevance) + (0.20 \times Keyword)
$$

| ìš”ì†Œ | ê°€ì¤‘ì¹˜ | ê³„ì‚° ë°©ì‹ |
|-----|--------|----------|
| **Recency** | 15% | `exp(-days_since_created / 30)` - ìµœê·¼ì¼ìˆ˜ë¡ ë†’ìŒ |
| **Importance** | 15% | `importance / 10` - LLMì´ 1~10ì  í‰ê°€ |
| **Relevance** | 50% | pgvector ì½”ì‚¬ì¸ ìœ ì‚¬ë„ |
| **Keyword** | 20% | PGroonga BM25 ì ìˆ˜ (í•œêµ­ì–´ í˜•íƒœì†Œ ë¶„ì„) |



## Dungeon AI Agent
```mermaid
flowchart TB
    C([ğŸ® í´ë¼ì´ì–¸íŠ¸]) --> E1[" ë˜ì „ ì…ì¥<br/>POST /entrance"]
    
    E1 --> A1["ğŸ¤– Event Agent<br/> 1ì¸µ, 2ì¸µ ë™ì‹œì— ì´ë²¤íŠ¸ ìƒì„±"]
    A1 --> P["ğŸ® í•´ë‹¹ì¸µ ì§„í–‰"]
    
    P --> EV{ì´ë²¤íŠ¸ ë°©<br/>ì…ì¥}
    EV -->|YES| ES["ì´ë²¤íŠ¸ ì„ íƒ<br/>POST /event/select<br/>(ì„ íƒì§€ ì…ë ¥ â†’ ë³´ìƒ/íŒ¨ë„í‹°)"]
    ES --> P
    EV -->|NO| P
    
    P --> B1["ë³´ìŠ¤ë°© ì…ì¥<br/>POST /balance"]
    B1 --> A2["ğŸ¤– Monster Agent<br/>ë‹¤ìŒì¸µ ëª¬ìŠ¤í„° ë°¸ëŸ°ì‹± ì¡°ì ˆ<br/>"]
    A2 --> CL[" í•´ë‹¹ì¸µ í´ë¦¬ì–´<br/>PUT /clear"]
    
    CL --> N["ë‹¤ìŒì¸µ ì…ì¥<br/>POST /nextfloor"]
    N --> A3["ğŸ¤– Event Agent<br/> ë‹¤ë‹¤ìŒì¸µ ì´ë²¤íŠ¸ ìƒì„±"]
    
    A3 -.-> |"ğŸ”„ ë°˜ë³µ"| B1
```

## Fairy AI Agent
```mermaid
flowchart LR
    subgraph Input["ì…ë ¥"]
        Q["ì§ˆë¬¸:<br/>ì € ëª¬ìŠ¤í„°ëŠ” ë­ì•¼?<br/>ë¬´ê¸°ë„ êµì²´í•´ì¤˜"]
    end

    subgraph IntentClassify["ì˜ë„ ë¶„ë¥˜"]
        direction TB
        IC0["ëª¨ë¸: Groq<br/>ë ˆì´í„´ì‹œ: 0.3s"]
        IC1["ë³‘ë ¬ ì˜ë„ ë¶„ë¥˜"]
        IC2["ëª¬ìŠ¤í„° ì •ë³´"]
        IC3["ì•„ì´í…œ ì‚¬ìš©"]
        IC0 --- IC1
        IC1 --> IC2
        IC1 --> IC3
    end

    subgraph LocalModel["ë¡œì»¬ ëª¨ë¸ ì¶”ë¡ "]
        direction TB
        LM0["ëª¨ë¸: KoBERT, BGE-M3<br/>ë ˆì´í„´ì‹œ: 0.1s"]
        LM1["ë³‘ë ¬ ëª¨ë¸ ì¶”ë¡ "]
        LM2["ë°ê¸° ì¡°ì ˆ"]
        LM3["ì•„ì´í…œ ì‚¬ìš© íŒë‹¨"]
        LM0 --- LM1
        LM1 --> LM2
        LM1 --> LM3
    end

    subgraph RAG["ë³‘ë ¬ ê²€ìƒ‰"]
        RAG1["ëª¬ìŠ¤í„° ì •ë³´ RAG"]
        RAG2["ëª¬ìŠ¤í„° ì •ì±…"]
        RAG3["ì¸ë²¤í† ë¦¬ ì •ë³´ ì¡°íšŒ"]
        RAG4["ì•„ì´í…œ ì‚¬ìš© ì •ì±…"]
    end

    subgraph PromptBuild["í”„ë¡¬í”„íŠ¸ ìƒì„±"]
        PB["...(ìƒëµ)...<br/>{ëª¬ìŠ¤í„° ì •ë³´}<br/>{ëª¬ìŠ¤í„° ì •ì±…}<br/>{ì•„ì´í…œ ì‚¬ìš© ì •ì±…}<br/>...(ìƒëµ)...<br/>ì§ˆë¬¸:{ì§ˆë¬¸}"]
    end

    subgraph ItemSelect["ì•„ì´í…œ ì„ íƒ"]
        direction TB
        IS0["ëª¨ë¸: Groq<br/>ë ˆì´í„´ì‹œ: 0.3s"]
        IS["ì•„ì´í…œ ì„ íƒ"]
        IS0 --- IS
    end

    subgraph Response["ì‘ë‹µ ìƒì„±"]
        direction TB
        R0["ëª¨ë¸: Grok4 Fast<br/>ë ˆì´í„´ì‹œ: 0.8~1.5s"]
        R["ì‘ë‹µ:<br/>ì €ê±´ ìŠ¤ì¼ˆë ˆí†¤ì´ì•¼!<br/>ê°€ì¥ ì„¼ ëŒ€ê²€ì„ ì¥ì°©í–ˆì–´!"]
        R0 --- R
    end

    subgraph Cost["í† í° ë¹„ìš©"]
        C1["(ì•„ì´í…œ ë¯¸ì‚¬ìš©)<br/>ë¹„ìš© ì—†ìŒ"]
        C2["(ì•„ì´í…œ ì‚¬ìš©)<br/>0.015 ë‹¬ëŸ¬"]
    end

    subgraph Output["ì‘ë‹µ í¬ë§·"]
        O["{ì•„ì´í…œ ì‚¬ìš© ID:20,<br/>ë˜ì „ ë°ê¸°: ë¯¸ì‚¬ìš©}"]
    end

    Q --> IntentClassify
    Q -->|"ìƒí˜¸ ì‘ìš©"| LocalModel
    
    IntentClassify -->|"ì•„ì´í…œ ë¯¸ì‚¬ìš©"| RAG
    RAG --> PromptBuild
    PromptBuild --> Response
    
    LocalModel -->|"ì•„ì´í…œ ì‚¬ìš©"| ItemSelect
    ItemSelect --> Output
    ItemSelect --> Cost
    
    Response --> Output

    style Q fill:#8B4513,color:#fff
    style IC0 fill:#555,color:#fff
    style IC1 fill:#333,color:#fff
    style IC2 fill:#333,color:#fff
    style IC3 fill:#333,color:#fff
    style LM0 fill:#555,color:#fff
    style LM1 fill:#333,color:#fff
    style LM2 fill:#333,color:#fff
    style LM3 fill:#333,color:#fff
    style RAG1 fill:#333,color:#fff
    style RAG2 fill:#333,color:#fff
    style RAG3 fill:#333,color:#fff
    style RAG4 fill:#333,color:#fff
    style PB fill:#333,color:#fff
    style IS0 fill:#555,color:#fff
    style IS fill:#333,color:#fff
    style R0 fill:#555,color:#fff
    style R fill:#D4A574,color:#000
    style O fill:#D4A574,color:#000
    style C1 fill:#D4A574,color:#000
    style C2 fill:#D4A574,color:#000
```

---

# 8. API ì—”ë“œí¬ì¸íŠ¸

## NPC API (`/api/npc/...`)

| Method | Endpoint | ì„¤ëª… | Request | Response |
|--------|----------|------|---------|----------|
| POST | `/login` | ê²Œì„ ì ‘ì† ì‹œ ì„¸ì…˜ ì´ˆê¸°í™”<br/>(1íšŒ í˜¸ì¶œ) | `playerId`, `scenarioLevel`, `heroines[]` | `success`, `message` |
| POST | `/heroine/chat/sync` | íˆë¡œì¸ ëŒ€í™” (í…ìŠ¤íŠ¸ë§Œ) | `playerId`, `heroineId`, `text` | `text`, `emotion`, `affection`, `sanity`, `memoryProgress` |
| POST | `/heroine/chat/sync/voice` | íˆë¡œì¸ ëŒ€í™” (TTS í¬í•¨) | `playerId`, `heroineId`, `text` | `text`, `emotion`, `affection`, `audio_base64` |
| POST | `/sage/chat/sync/voice` | ëŒ€í˜„ì ëŒ€í™” (TTS í¬í•¨) | `playerId`, `text` | `text`, `emotion`, `scenarioLevel`, `audio_base64` |
| POST | `/heroine-conversation/generate/voice` | NPC ê°„ ëŒ€í™” ìƒì„± (TTS) | `playerId`, `heroine1Id`, `heroine2Id`, `turnCount` | `conversation[]`, `audio_base64` (per turn) |
| POST | `/heroine-conversation/interrupt` | NPC ê°„ ëŒ€í™” ì¸í„°ëŸ½íŠ¸<br/>(User ê°œì… ì‹œ) | `playerId`, `conversationId`, `interruptedTurn` | `success`, `message`, `updated_memories` |
| GET | `/session/{player_id}/{npc_id}` | ì„¸ì…˜ ì •ë³´ ì¡°íšŒ (ë””ë²„ê·¸ìš©) | - | `conversation_buffer`, `state`, `turn_count` |

**ìƒì„¸ ë¬¸ì„œ**: [API_FLOW.md](docs/API_FLOW.md)

---

## Dungeon API (`/api/dungeon/...`)

| Method | Endpoint | ì„¤ëª… | Request | Response |
|--------|----------|------|---------|----------|
| POST | `/entrance` | ë˜ì „ ì§„ì…<br/>(raw_map ì œì¶œ) | `playerIds[]`, `heroineIds[]`, `rawMaps[]` | `dungeonIds[]`, `events[]` |
| POST | `/balance` | AI ë°¸ëŸ°ì‹± ì‹¤í–‰<br/>(ì´ë²¤íŠ¸ + ëª¬ìŠ¤í„°) | `firstPlayerId`, `playerDataList[]`, `monsterDb` | `balancedMap`, `summaryInfo`, `events`, `monsterStats` |
| PUT | `/clear` | í˜„ì¬ ì¸µ í´ë¦¬ì–´ | `playerIds[]` | `success`, `balancedMap` (ë‹¤ìŒ ì¸µìš©) |
| POST | `/event/select` | ì´ë²¤íŠ¸ ì„ íƒì§€ ì²˜ë¦¬ | `firstPlayerId`, `roomId`, `choice` | `success`, `rewards[]`, `penalties[]` |
| POST | `/nextfloor` | ë‹¤ìŒ ì¸µ ì§„ì… | `playerIds[]`, `heroineIds[]`, `rawMap` | `dungeonId`, `event` |

**ìƒì„¸ ë¬¸ì„œ**: [DUNGEON_API_SPECIFICATION_V2.md](docs/DUNGEON_API_SPECIFICATION_V2.md)

---

## Fairy API (`/api/fairy/...`)

| Method | Endpoint | ì„¤ëª… | Request | Response |
|--------|----------|------|---------|----------|
| POST | `/dungeon/talk` | ë˜ì „ ê°€ì´ë“œ ëŒ€í™” | `dungeonPlayer`, `question`, `targetMonsterIds[]`, `nextRoomIds[]` | `responseText` |
| POST | `/dungeon/interaction` | ë˜ì „ ìƒí˜¸ì‘ìš©<br/>(ì•„ì´í…œ, ì¡°ëª…) | `dungeonPlayer`, `question` | `useItemId`, `roomLight` (0/1/2) |
| POST | `/guild/talk` | ê¸¸ë“œ ê°€ì´ë“œ ëŒ€í™” | `playerId`, `heroine_id`, `memory_progress`, `affection`, `sanity`, `question` | `responseText` |

**ìƒì„¸ ë¬¸ì„œ**: [FAIRY_API_PROTOCOL.md](docs/FAIRY_API_PROTOCOL.md)

---

# 9. ê°œë°œ ê°€ì´ë“œ

## í…ŒìŠ¤íŠ¸ ì‹¤í–‰

```bash
# NPC í˜ë¥´ì†Œë‚˜ í‰ê°€ (DeepEval)
uv run pytest src/tests/npc/persona_eval/test_npc_persona.py -v

# ì „ì²´ í…ŒìŠ¤íŠ¸
uv run pytest src/tests/ -v
```

---

## DeepEval í˜ë¥´ì†Œë‚˜ í‰ê°€ ë©”íŠ¸ë¦­

NPC ëŒ€í™” ì‹œìŠ¤í…œì€ **4ê°œì˜ ì»¤ìŠ¤í…€ ë©”íŠ¸ë¦­**ìœ¼ë¡œ í˜ë¥´ì†Œë‚˜ ì¼ê´€ì„±ì„ í‰ê°€í•©ë‹ˆë‹¤.

### ë©”íŠ¸ë¦­ êµ¬ì„±

| ë©”íŠ¸ë¦­ | ì„ê³„ê°’ | ì„¤ëª… | ì£¼ìš” í…ŒìŠ¤íŠ¸ ìœ í˜• |
|--------|--------|------|------------------|
| **PersonaConsistency** | 70% | ìºë¦­í„° ì„±ê²© ì¼ê´€ì„± (ë§íˆ¬, ì„±ê²©, ì„ í˜¸ë„ ìœ ì§€) | general, persona_test |
| **RoleAdherence** | 90% | ë¡¤í”Œë ˆì´ ìœ ì§€ (AI ì—¬ë¶€ ìˆ¨ê¹€, ìºë¦­í„° ëª°ì…) | persona_break |
| **KnowledgeBoundary** | 80% | ì§€ì‹ ê²½ê³„ ì¤€ìˆ˜ (í•´ê¸ˆë˜ì§€ ì•Šì€ ì •ë³´ ì°¨ë‹¨) | knowledge_boundary, memory |
| **ConversationMemory** | 80% | ëŒ€í™” ë§¥ë½ ê¸°ì–µ (ì´ì „ ëŒ€í™” ë‚´ìš© ì°¸ì¡°) | multi_turn_memory |

### í…ŒìŠ¤íŠ¸ ìœ í˜• êµ¬ì„± (6ê°€ì§€)

| í…ŒìŠ¤íŠ¸ ìœ í˜• | ë¹„ìœ¨ | ì£¼ìš” ë©”íŠ¸ë¦­ (60%) | ë³´ì¡° ë©”íŠ¸ë¦­ (40% ê· ë“±) | ì„¤ëª… |
|------------|------|-------------------|----------------------|------|
| **general** | 20% | PersonaConsistency | RoleAdherence, KnowledgeBoundary | ì¼ë°˜ ëŒ€í™” (ê¸°ë¶„, ì·¨í–¥) |
| **persona_test** | 20% | PersonaConsistency | RoleAdherence | íŠ¸ë¼ìš°ë§ˆ/ì„±ê²© í…ŒìŠ¤íŠ¸ |
| **persona_break** | 20% | RoleAdherence | PersonaConsistency, KnowledgeBoundary | AI ì—¬ë¶€ í™•ì¸ ì‹œë„ |
| **memory** | 20% | KnowledgeBoundary | PersonaConsistency | ìºë¦­í„° ê³¼ê±° ê¸°ì–µ í•´ê¸ˆë„ |
| **knowledge_boundary** | 10% | KnowledgeBoundary | PersonaConsistency, RoleAdherence | ì•Œ ìˆ˜ ì—†ëŠ” ì§€ì‹ ì°¨ë‹¨ |
| **multi_turn_memory** | 10% | ConversationMemory | PersonaConsistency, RoleAdherence | ëŒ€í™” ë§¥ë½ ê¸°ì–µ |

### í…ŒìŠ¤íŠ¸ ì˜ˆì‹œ

```bash
# ë ˆí‹°ì•„(íˆë¡œì¸ 1) í˜ë¥´ì†Œë‚˜ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
uv run pytest src/tests/npc/persona_eval/test_npc_persona.py::test_letia_persona -v

# ì „ì²´ íˆë¡œì¸ í˜ë¥´ì†Œë‚˜ í‰ê°€
uv run pytest src/tests/npc/persona_eval/ -v

# íŠ¹ì • í…ŒìŠ¤íŠ¸ ìœ í˜•ë§Œ ì‹¤í–‰
uv run pytest src/tests/npc/persona_eval/ -k "persona_break" -v
```


## ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬

**ì´ˆê¸°í™” (ëª¨ë“  ë°ì´í„° ì‚­ì œ):**

```bash
docker-compose down -v
docker-compose up -d
# init.sqlì´ ìë™ ì‹¤í–‰ë˜ì–´ í…Œì´ë¸” ì¬ìƒì„±
```

**ì‹œë‚˜ë¦¬ì˜¤ ì‹œë”©:**

```bash
# íˆë¡œì¸ ì‹œë‚˜ë¦¬ì˜¤ ë°ì´í„° ì‚½ì…
uv run python src/scripts/seed_scenarios.py
```

**Langfuse í† í° ë¶„ì„:**

```bash
# í† í° ì‚¬ìš©ëŸ‰, ë¹„ìš© ë¶„ì„
uv run python src/scripts/analyze_langfuse_tokens.py
```

---

# 10. ì½”ë“œ ì»¨ë²¤ì…˜

- **[CONVENTION.md](CONVENTION.md)** ì°¸ì¡°
- **SOLID ì›ì¹™** ì¤€ìˆ˜
- **Docstring**: Google Style
- **Type Hints** í•„ìˆ˜

**ì˜ˆì‹œ:**

```python
def calculate_affection_change(
    user_message: str,
    liked_keywords: List[str],
    trauma_keywords: List[str]
) -> int:
    """í‚¤ì›Œë“œ ê¸°ë°˜ í˜¸ê°ë„ ë³€í™”ëŸ‰ì„ ê³„ì‚°í•©ë‹ˆë‹¤.

    Args:
        user_message: ì‚¬ìš©ì ë©”ì‹œì§€
        liked_keywords: ì¢‹ì•„í•˜ëŠ” í‚¤ì›Œë“œ ë¦¬ìŠ¤íŠ¸
        trauma_keywords: íŠ¸ë¼ìš°ë§ˆ í‚¤ì›Œë“œ ë¦¬ìŠ¤íŠ¸

    Returns:
        í˜¸ê°ë„ ë³€í™”ëŸ‰ (ì–‘ìˆ˜: ì¦ê°€, ìŒìˆ˜: ê°ì†Œ)
    """
    change = 0
    for keyword in liked_keywords:
        if keyword in user_message:
            change += 10
    for keyword in trauma_keywords:
        if keyword in user_message:
            change -= 10
    return change
```

---

# 11. ê´€ë ¨ ë¬¸ì„œ

## API í”„ë¡œí† ì½œ
- [API_FLOW.md](docs/NPC_API_PROTOCOL.md): NPC ëŒ€í™” API ìƒì„¸ (Request/Response ì˜ˆì‹œ, í˜¸ì¶œ íë¦„ë„)
- [FAIRY_API_PROTOCOL.md](docs/FAIRY_API_PROTOCOL.md): Fairy ê°€ì´ë“œ API ìƒì„¸ (ì¶”ì •)
- [DUNGEON_API_SPECIFICATION_V2.md](docs/DUNGEON_API_SPECIFICATION_V2.md): Dungeon ìƒì„± API ìƒì„¸

## ê¸°ìˆ  ë¬¸ì„œ
- [NPC_CONTEXT.md](docs/NPC_CONTEXT.md): NPC ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜
- [í•µì‹¬ê¸°ìˆ  ì •ë¦¬.md](docs/í•µì‹¬ê¸°ìˆ %20ì •ë¦¬.md): 10ê°€ì§€ í•µì‹¬ ê¸°ìˆ  ì„ íƒ ì´ìœ  ë° êµ¬í˜„ ë°©ë²•
- [NPC_DATA_FLOW.md](docs/NPC_DATA_FLOW.md): ë°ì´í„° íë¦„ë„
- [CONVENTION.md](CONVENTION.md): ì½”ë“œ ì»¨ë²¤ì…˜

## ì¶”ê°€ ë¦¬ì†ŒìŠ¤

- [LangChain ê³µì‹ ë¬¸ì„œ](https://python.langchain.com/)
- [LangGraph ê³µì‹ ë¬¸ì„œ](https://langchain-ai.github.io/langgraph/)
- [FastAPI ê³µì‹ ë¬¸ì„œ](https://fastapi.tiangolo.com/)
- [pgvector GitHub](https://github.com/pgvector/pgvector)
- [PGroonga ê³µì‹ ë¬¸ì„œ](https://pgroonga.github.io/)
- [langfuse ê³µì‹ ë¬¸ì„œ](https://langfuse.com/docs)
- [deepeval ê³µì‹ ë¬¸ì„œ](https://deepeval.com/docs/getting-started)
---

## 12. ë¬¸ì˜
- **Email**: immortal0900@gmail.com